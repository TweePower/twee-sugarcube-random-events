// repository: https://github.com/TweePower/test
(function () {
    'use strict';

var RandomEventAppExport;(()=>{"use strict";var __webpack_modules__={60:(t,e,o)=>{o.d(e,{A:()=>c});var n=o(755),i=o(103),r=o(643);const a=function(){function t(t,e,o,n,i){this.name=t,this.weight=e,this.type=o,this.sequentialIndex=n,this.sequentialCount=i}return t.createFromGroupDefinition=function(e){var o,n;if("string"==typeof e)return new t(e.toLowerCase(),10,r.M.Random,null,null);if(i.A.isObject(e)){if(!i.A.isString(e.name))throw new Error('"definition.group.name" should be string');if(void 0!==e.weight&&!i.A.isInteger(e.weight))throw new Error('"definition.group.weight" should be integer');if(void 0!==e.type&&"random"!==e.type&&"sequential"!==e.type)throw new Error('"definition.group.type" should be "random" or "sequential"');if("sequential"===e.type){if(void 0===e.sequentialIndex)throw new Error('"definition.group.sequentialIndex" is requered when "definition.group.type" = "sequential"');if(!i.A.isInteger(e.sequentialIndex))throw new Error('"definition.group.sequentialIndex" should be integer');if(void 0!==e.sequentialCount&&!i.A.isInteger(e.sequentialCount))throw new Error('"definition.group.sequentialCount" should be integer')}return new t(e.name.toLowerCase(),null!==(o=e.weight)&&void 0!==o?o:10,"sequential"===e.type?r.M.Sequential:r.M.Random,"sequential"===e.type?e.sequentialIndex:null,"sequential"===e.type?null!==(n=e.sequentialCount)&&void 0!==n?n:1:null)}throw new Error('"definition.group" should be string, object')},t}(),s=function(){function t(t){var e=this;this.groups=t,this.nameIndex={},this.groups=t,this.groups.forEach((function(t,o){if(void 0!==e.nameIndex[t.name])throw new Error('"definition.group.name" should be unique in one RE');e.nameIndex[t.name]=o}))}return t.createFromGroupsDefinition=function(e){return void 0===e?new t([]):(Array.isArray(e)||(e=[e]),new t(e.map((function(t){return a.createFromGroupDefinition(t)}))))},Object.defineProperty(t.prototype,"length",{get:function(){return this.groups.length},enumerable:!1,configurable:!0}),t.prototype.all=function(){return this.groups},t.prototype.getByName=function(t){return void 0===this.nameIndex[t]?null:this.groups[this.nameIndex[t]]},t}(),l=function(){function t(t,e,o){if(this.max=t,this.isSeparate=e,this.tags=o,o.isHaveTweeScriptTags)throw new Error('"definition.limitationStrategy[...].tags" should be string')}return t.createFromLimitationStrategyDefinition=function(e){var o;if(!i.A.isInteger(e.max))throw new Error('"definition.limitationStrategy[...].max" should be integer');if(e.max<0)throw new Error('"definition.limitationStrategy[...].max" should equal or greater than 0');if(void 0!==e.isSeparate&&!i.A.isBoolean(e.isSeparate))throw new Error('"definition.limitationStrategy[...].isSeparate" should be boolean');return new t(e.max,null!==(o=e.isSeparate)&&void 0!==o&&o,n.A.createFromTagsDefinition(e.tags))},t}(),d=function(){function t(t){var e=this;this.limitationStrategies=t,this.isTaged=!1;var o={};this.limitationStrategies.forEach((function(t){if(!e.isTaged&&t.tags.length>0&&(e.isTaged=!0),void 0!==o[t.tags.toStringKey()])throw new Error('"definition.limitationStrategy" should containg uniq tag sets (tags: "'.concat(t.tags.tags.map((function(t){return t.tag})).join('", "'),'")'));o[t.tags.toStringKey()]=!0}))}return t.createFromLimitationStrategiesDefinition=function(e){if(void 0===e)return new t([]);if(!i.A.isArray(e))throw new Error('"definition.limitationStrategy" should be array');return new t(e.map((function(t){return l.createFromLimitationStrategyDefinition(t)})))},Object.defineProperty(t.prototype,"length",{get:function(){return this.limitationStrategies.length},enumerable:!1,configurable:!0}),t.prototype.all=function(){return this.limitationStrategies},t}(),c=function(){function t(t,e,o,n,i,r,a,s){this.name=t,this.isEnabled=e,this.groups=o,this.filter=n,this.type=i,this.threshold=r,this.tags=a,this.limitationStrategy=s}return t.createFromDefinition=function(t){if("string"!=typeof t.name)throw new Error('"definition.name" should be string');if(void 0===t.isEnabled)t.isEnabled=!0;else if("boolean"!=typeof t.isEnabled)throw new Error('"definition.isEnabled" should be boolean (name: '.concat(t.name,")"));try{t.groups=s.createFromGroupsDefinition(t.group)}catch(e){throw e.message="".concat(e.message," (name: ").concat(t.name,")"),e}if(void 0===t.filter)t.filter=null;else if(null!==t.filter&&"string"!=typeof t.filter)throw new Error('"definition.filter" should be string or null (name: '.concat(t.name,")"));if(void 0===t.type)t.type="embaded";else if("embaded"!==t.type&&"goto"!==t.type)throw new Error('"definition.type" should be "embaded" or "goto" (name: '.concat(t.name,")"));if(void 0===t.threshold)t.threshold=100;else if("number"==typeof t.threshold){if(t.threshold<0)throw new Error('"definition.threshold" should be >= than 0 (name: '.concat(t.name,")"));if(t.threshold>100)throw new Error('"definition.threshold" should be <= than 100 (name: '.concat(t.name,")"))}try{t.tags=n.A.createFromTagsDefinition(t.tags)}catch(e){throw e.message="".concat(e.message," (name: ").concat(t.name,")"),e}try{t.limitationStrategy=d.createFromLimitationStrategiesDefinition(t.limitationStrategy)}catch(e){throw e.message="".concat(e.message," (name: ").concat(t.name,")"),e}return new this(t.name,t.isEnabled,t.groups,t.filter,t.type,t.threshold,t.tags,t.limitationStrategy)},t}()},358:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(103),_RandomEvent__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(60),RandomEventCollector=function(){function RandomEventCollector(t,e,o){this.randomEventCollection=t,this.randomEventTag=e,this.randomEventDefinitionRegex=o,this.isInit=!1}return RandomEventCollector.prototype.init=function(){var _this=this;if(!this.isInit){var randomEventPassages=Story.lookup().filter((function(t){return t.tags.includes(_this.randomEventTag)}));randomEventPassages.forEach((function(passage){_this.randomEventDefinitionRegex.lastIndex=0;var randomEventDefinitionResult=_this.randomEventDefinitionRegex.exec(passage.element.textContent);if(null===randomEventDefinitionResult)throw new Error("Random event definition not found in ".concat(passage.title));var randomEventDefinition=randomEventDefinitionResult[1],randomEventDefinitionEvalResult;try{if(eval("randomEventDefinitionEvalResult = "+randomEventDefinition),!_tools_TypeChecker__WEBPACK_IMPORTED_MODULE_0__.A.isObject(randomEventDefinitionEvalResult))throw new Error("Random event definition JSON should contain object")}catch(t){throw t.message="Invalid random event definition JSON in passage ".concat(passage.title,": ").concat(t.message),t}randomEventDefinitionEvalResult.name=passage.title,_this.randomEventCollection.add(_RandomEvent__WEBPACK_IMPORTED_MODULE_1__.A.createFromDefinition(randomEventDefinitionEvalResult)),passage.element.textContent=passage.element.textContent.replace(randomEventDefinitionResult[0],"").trim()})),this.randomEventCollection.cleanUp(),this.isInit=!0}},RandomEventCollector}();const __WEBPACK_DEFAULT_EXPORT__=RandomEventCollector},755:(t,e,o)=>{o.d(e,{A:()=>n});const n=function(){function t(e){var o=this;this.isHaveTweeScriptTags=!1,this.tags=[],this.stringTags=[],e.forEach((function(e){t.isHaveTweeScript(e)?(o.tags.push({isHaveTweeScript:!0,tag:e}),o.isHaveTweeScriptTags=!0):(e=e.toLowerCase().trim().replace(" ","__"),o.tags.push({isHaveTweeScript:!1,tag:e}),o.stringTags.push(e))})),this.stringTags.sort(),this.isHaveTweeScriptTags||(this.tags=null)}return t.isHaveTweeScript=function(t){return!/^\w+[\w_\- ]+$/.test(t)},t.createFromTagsDefinition=function(e){if(void 0===e)return new t([]);if(!Array.isArray(e))throw new Error('"definition.tags" should be array');return new t(e.map((function(t){if("string"!=typeof t)throw new Error('"definition.tags[...]" should be string');return t})))},Object.defineProperty(t.prototype,"length",{get:function(){return this.isHaveTweeScriptTags?this.tags.length:this.stringTags.length},enumerable:!1,configurable:!0}),t.prototype.getStringTags=function(){return this.stringTags},t.prototype.getCompiledTags=function(){return this.isHaveTweeScriptTags?this.tags.map((function(t){if(!t.isHaveTweeScript)return t.tag;try{return Scripting.evalJavaScript(Scripting.parse(t.tag)).toLowerCase().trim().replace(" ","__")}catch(e){throw new Error("Invalid random event scripted tag: "+t.tag)}})).sort():this.stringTags},t.prototype.toStringKey=function(){return this.getCompiledTags().join("_")},t}()},643:(t,e,o)=>{var n;o.d(e,{M:()=>n}),function(t){t.Random="random",t.Sequential="sequential"}(n||(n={}))},103:(t,e,o)=>{o.d(e,{A:()=>n});const n=function(){function t(){}return t.isString=function(t){return"string"==typeof t||t instanceof String},t.isBoolean=function(t){return"boolean"==typeof t||t instanceof Boolean},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isInteger=function(e){return t.isNumber(e)&&e%1==0},t.isFloat=function(e){return t.isNumber(e)&&e%1!=0},t.isNumber=function(t){return"number"==typeof t&&!isNaN(t)},t.isStringInteger=function(e){return t.isString(e)&&!isNaN(e)&&t.isInteger(parseFloat(e))},t.isStringFloat=function(e){return t.isString(e)&&!isNaN(e)&&t.isFloat(parseFloat(e))},t.isStringNumber=function(e){return t.isString(e)&&!isNaN(e)&&t.isNumber(parseFloat(e))},t.isObject=function(t){return"object"==typeof t&&!Array.isArray(t)&&null!==t},t}()}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var o=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](o,o.exports,__webpack_require__),o.exports}__webpack_require__.d=(t,e)=>{for(var o in e)__webpack_require__.o(e,o)&&!__webpack_require__.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>v});var t=__webpack_require__(103),e=__webpack_require__(60),o=__webpack_require__(643),n=__webpack_require__(755),i=function(t,e,o){if(o||2===arguments.length)for(var n,i=0,r=e.length;i<r;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))};const r=function(){function r(){this.items={},this.tagIndex={},this.limitationStrategyTagIndex={},this.groupIndex={},this.validationGroup={}}return r.prototype.cleanUp=function(){this.validationGroup={}},r.prototype.add=function(t){var r=this;if(!(t instanceof e.A))throw new Error("randomEvent should be instance of RandomEvent");t.groups.all().forEach((function(e){if(void 0===r.validationGroup[e.name])r.validationGroup[e.name]={type:e.type.toString(),indexes:[e.sequentialIndex]};else{if(r.validationGroup[e.name].type!==e.type)throw new Error('Group type should be the same. Group name: "'.concat(e.name,'". Passage name: "').concat(t.name,'". Other passages: "').concat(r.groupIndex[e.name].join(", "),'"'));if(e.type===o.M.Sequential){if(r.validationGroup[e.name].indexes.includes(e.sequentialIndex))throw new Error("Random event with sequentialIndex ".concat(e.sequentialIndex," should be unique (name: ").concat(t.name,' ,group: "').concat(e.name,'")'));r.validationGroup[e.name].indexes.push(e.sequentialIndex)}}void 0===r.groupIndex[e.name]&&(r.groupIndex[e.name]=[]),r.groupIndex[e.name].push(t.name)})),i([],t.tags.getStringTags(),!0).forEach((function(e){void 0===r.tagIndex[e]&&(r.tagIndex[e]=[]),r.tagIndex[e].push(t.name)})),t.limitationStrategy.length>0&&t.limitationStrategy.isTaged&&t.limitationStrategy.all().forEach((function(e){e.tags.getStringTags().forEach((function(o){void 0===r.limitationStrategyTagIndex[o]&&(r.limitationStrategyTagIndex[o]={events:[],tagGroups:{}}),r.limitationStrategyTagIndex[o].events.push(t.name);var a=i([],e.tags.getStringTags(),!0);e.isSeparate&&a.push(t.name),r.limitationStrategyTagIndex[o].tagGroups[new n.A(a).toStringKey()]=a}))})),this.items[t.name]=t},r.prototype.has=function(e){if(!t.A.isString(e))throw new Error('Invalid "RandomEventCollection.has" argument type');return void 0!==this.items[e]},r.prototype.get=function(t){if(!this.has(t))throw new Error("Random event with name ".concat(t," doesn't exist"));return this.items[t]},r.prototype.find=function(t){return this.has(t)?this.items[t]:null},r.prototype.enable=function(t){if(!this.has(t))throw new Error("Random event with name ".concat(t," doesn't exist"));this.items[t].isEnabled=!0},r.prototype.disable=function(t){if(!this.has(t))throw new Error("Random event with name ".concat(t," doesn't exist"));this.items[t].isEnabled=!1},r.prototype.getEventsNamesByTag=function(t){return void 0===this.tagIndex[t]?[]:this.tagIndex[t]},r.prototype.getEventsNamesByLimitationStrategyTag=function(t){return void 0===this.limitationStrategyTagIndex[t]?[]:this.limitationStrategyTagIndex[t].events},r.prototype.getTagGroupsByLimitationStrategyTag=function(t){return void 0===this.limitationStrategyTagIndex[t]?[]:Object.values(this.limitationStrategyTagIndex[t].tagGroups)},r.prototype.hasGroup=function(t){return void 0!==this.groupIndex[t]},r.prototype.getEventsNamesByGroup=function(t){var e;return null!==(e=this.groupIndex[t])&&void 0!==e?e:[]},r}(),a=function(){function t(){this.actualFiredEvents={},this.actualFiredTags={},this.historyFiredEvents={},this.historyFiredTags={},this.forceEventStatus={}}return t.prototype.loadFromSerilizedString=function(t){var e=this,o=JSON.parse(t);Object.keys(o.e).forEach((function(t){void 0!==o.e[t].a&&(e.actualFiredEvents[t]=o.e[t].a),void 0!==o.e[t].h&&(e.historyFiredEvents[t]=o.e[t].h),void 0!==o.e[t].s&&(e.forceEventStatus[t]=1===o.e[t].s)})),Object.keys(o.t).forEach((function(t){void 0!==o.t[t].a&&(e.actualFiredTags[t]=o.t[t].a),void 0!==o.t[t].h&&(e.historyFiredTags[t]=o.t[t].h)}))},t.prototype.serialize=function(){var t=this,e={e:{},t:{}};return Object.keys(this.actualFiredEvents).forEach((function(o){void 0===e.e[o]&&(e.e[o]={}),e.e[o].a=t.actualFiredEvents[o]})),Object.keys(this.historyFiredEvents).forEach((function(o){void 0===e.e[o]&&(e.e[o]={}),e.e[o].h=t.historyFiredEvents[o]})),Object.keys(this.forceEventStatus).forEach((function(o){void 0===e.e[o]&&(e.e[o]={}),e.e[o].s=!0===t.forceEventStatus[o]?1:0})),Object.keys(this.actualFiredTags).forEach((function(o){void 0===e.t[o]&&(e.t[o]={}),e.t[o].a=t.actualFiredTags[o]})),Object.keys(this.historyFiredTags).forEach((function(o){void 0===e.t[o]&&(e.t[o]={}),e.t[o].h=t.historyFiredTags[o]})),JSON.stringify(e)},t.prototype.store=function(){State.variables.randomEventHistory=this.serialize()},t.prototype.setActualRandomEventFiredCounter=function(t,e){t=t.toLowerCase(),this.actualFiredEvents[t]=e},t.prototype.setActualTagFiredCounter=function(t,e){t=t.toLowerCase(),this.actualFiredTags[t]=e},t.prototype.setHistoryRandomEventFiredCounter=function(t,e){t=t.toLowerCase(),this.historyFiredEvents[t]=e},t.prototype.setHistoryTagFiredCounter=function(t,e){t=t.toLowerCase(),this.historyFiredTags[t]=e},t.prototype.enable=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),this.forceEventStatus[t]=!0,e&&this.store()},t.prototype.disable=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),this.forceEventStatus[t]=!1,e&&this.store()},t.prototype.incrementRandomEventFiredCounter=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),this.actualFiredEvents[t]=void 0===this.actualFiredEvents[t]?1:this.actualFiredEvents[t]+1,this.historyFiredEvents[t]=void 0===this.historyFiredEvents[t]?1:this.historyFiredEvents[t]+1,e&&this.store()},t.prototype.incrementTagsFiredCounter=function(t,e){var o=this;void 0===e&&(e=!0),null!==t&&(t.filter((function(t,e,o){return o.indexOf(t)===e})).forEach((function(t){t=t.toLowerCase(),o.actualFiredTags[t]=void 0===o.actualFiredTags[t]?1:o.actualFiredTags[t]+1,o.historyFiredTags[t]=void 0===o.historyFiredTags[t]?1:o.historyFiredTags[t]+1})),e&&this.store())},t.prototype.resetRandomEventFiredCounter=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),void 0!==this.actualFiredEvents[t]&&delete this.actualFiredEvents[t],e&&this.store()},t.prototype.resetTagFiredCounter=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),void 0!==this.actualFiredTags[t]&&delete this.actualFiredTags[t],e&&this.store()},t.prototype.getActualFiredEventCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.actualFiredEvents[t])&&void 0!==e?e:0},t.prototype.getActualFiredTagCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.actualFiredTags[t])&&void 0!==e?e:0},t.prototype.getHistoryFiredEventCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.historyFiredEvents[t])&&void 0!==e?e:0},t.prototype.getHistoryFiredTagCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.historyFiredTags[t])&&void 0!==e?e:0},t}();var s=__webpack_require__(358);const l=function(){function t(){this.lockData={isLocked:!1,isForce:!1}}return t.prototype.acquire=function(){!1===this.lockData.isForce&&(this.lockData.isLocked=!0)},t.prototype.release=function(){!1===this.lockData.isForce&&(this.lockData.isLocked=!1)},t.prototype.forceAcquire=function(){this.lockData.isLocked=!0,this.lockData.isForce=!0},t.prototype.forceRelease=function(){this.lockData.isLocked=!1,this.lockData.isForce=!1},Object.defineProperty(t.prototype,"isLocked",{get:function(){return this.lockData.isLocked},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isForce",{get:function(){return this.lockData.isForce},enumerable:!1,configurable:!0}),t}(),d=function(){function e(t,e){this.randomEventCollection=t,this.randomEventHistory=e,this.isLoaded=!1}return e.prototype.forceSetIsLoadedFlag=function(t){this.isLoaded=t},e.prototype.resetIsLoadedFlag=function(){this.isLoaded=!1},e.prototype.loadState=function(t){var e=this;this.isLoaded||(this.oldLoadState(t),this.isLoaded||void 0!==t.randomEventHistory&&(this.randomEventHistory.loadFromSerilizedString(t.randomEventHistory),Object.keys(this.randomEventHistory.forceEventStatus).forEach((function(t){e.randomEventHistory.forceEventStatus[t]?e.randomEventCollection.enable(t):e.randomEventCollection.disable(t)})),this.isLoaded=!0))},e.prototype.oldLoadState=function(e){var o=this;if(!this.isLoaded){if(void 0!==e.randomEventFiredEvents){var n=JSON.parse(e.randomEventFiredEvents);Object.keys(n).forEach((function(e){""!==e&&(t.A.isInteger(n[e])&&n[e]>0?(o.randomEventHistory.setActualRandomEventFiredCounter(e.toLowerCase(),n[e]),o.randomEventHistory.setHistoryRandomEventFiredCounter(e.toLowerCase(),n[e])):o.randomEventHistory.setHistoryRandomEventFiredCounter(e.toLowerCase(),1))})),delete e.randomEventFiredEvents,this.isLoaded=!0}if(void 0!==e.randomEventFiredTags){var i=JSON.parse(e.randomEventFiredTags);Object.keys(i).forEach((function(e){""!==e&&(t.A.isInteger(i[e])&&i[e]>0?(o.randomEventHistory.setActualTagFiredCounter(e.toLowerCase(),i[e]),o.randomEventHistory.setHistoryTagFiredCounter(e.toLowerCase(),i[e])):o.randomEventHistory.setHistoryTagFiredCounter(e.toLowerCase(),1))})),delete e.randomEventFiredTags,this.isLoaded=!0}if(void 0!==e.randomEventEnabledEvents){var r=JSON.parse(e.randomEventEnabledEvents);t.A.isArray(r)&&r.forEach((function(t){o.randomEventCollection.has(t)&&(o.randomEventCollection.enable(t),o.randomEventHistory.enable(t,!1))})),delete e.randomEventEnabledEvents,this.isLoaded=!0}if(void 0!==e.randomEventDisabledEvents){var a=JSON.parse(e.randomEventDisabledEvents);t.A.isArray(a)&&a.forEach((function(t){o.randomEventCollection.has(t)&&(o.randomEventCollection.disable(t),o.randomEventHistory.disable(t,!1))})),delete e.randomEventDisabledEvents,this.isLoaded=!0}this.isLoaded&&this.randomEventHistory.store()}},e}(),c=function(){function t(t){if(void 0===t&&(t=0),this.debugLevel=t,this.currentLevel=0,this.logs=[],0!==t&&1!==t&&2!==t&&3!==t)throw new Error("Debug level should be 0, 1, 2 or 3")}return t.prototype.addLog=function(t,e,o,n){return this.logs.push({result:t,message:e,debugLevel:o,level:void 0===n?this.currentLevel:n}),this},t.prototype.merge=function(t){var e=this;return t.all().forEach((function(t){return e.addLog(t.result,t.message,t.debugLevel,t.level+e.currentLevel)})),this},t.prototype.increaseLevel=function(){return this.currentLevel++,this},t.prototype.decreaseLevel=function(){return this.currentLevel--,this.currentLevel<0&&(this.currentLevel=0),this},Object.defineProperty(t.prototype,"length",{get:function(){return this.logs.length},enumerable:!1,configurable:!0}),t.prototype.all=function(){return this.logs},t.prototype.toString=function(){var t=this;return this.logs.filter((function(e){return e.debugLevel<=t.debugLevel})).map((function(t){return"  ".repeat(t.level)+(!0===t.result?"+ ":!1===t.result?"- ":"")+t.message})).join("\n")},t.prototype.clear=function(){return this.currentLevel=0,this.logs=[],this},t}();var u=function(t,e,o){if(o||2===arguments.length)for(var n,i=0,r=e.length;i<r;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))};const g=function(){function t(t){this.randomEventHistory=t}return t.prototype.verify=function(t,e){var o,n,i,r,a,s=!0,l=[],d=new c,u=t.tags.getCompiledTags();return!0===e.isValidateIsEnable?(s=(a=this.verifyIsEnable(null!==(o=e.isEnable)&&void 0!==o?o:t.isEnabled)).result,d.addLog(a.result,"verify IsEnable using: ".concat(e.isEnable?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(a.debugLogCollector).decreaseLevel()):d.addLog(!0,"skip IsEnable verify",2),s&&(!0===e.isValidateFilter?(s=(a=this.verifyFilter(null!==(n=e.filter)&&void 0!==n?n:t.filter)).result,d.addLog(a.result,"verify filter using: ".concat(e.filter?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(a.debugLogCollector).decreaseLevel()):d.addLog(!0,"skip filter verify",2)),s&&(e.isValidateLimitationStrategy?(s=(a=this.verifyLimitationStrategy(u,null!==(i=e.limitationStrategy)&&void 0!==i?i:t.limitationStrategy,t.name)).result,d.addLog(a.result,"verify limitationStrategy using: ".concat(e.limitationStrategy?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(a.debugLogCollector).decreaseLevel(),l=a.additionalData.usedLimitationStrategyTags):d.addLog(!0,"skip limitationStrategy verify",2)),s&&(e.isValidateThreshold?(s=(a=this.verifyThreshold(null!==(r=e.threshold)&&void 0!==r?r:t.threshold)).result,d.addLog(a.result,"verify threshold using: ".concat(e.threshold?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(a.debugLogCollector).decreaseLevel()):d.addLog(!0,"skip threshold verify",2)),{result:s,debugLogCollector:d,additionalData:{usedLimitationStrategyTags:l}}},t.prototype.verifyIsEnable=function(t){return{result:t,debugLogCollector:(new c).addLog(t,t?"event enabled":"event disabled",3)}},t.prototype.verifyFilter=function(t){var e=new c;if(null!==t)try{if(!Scripting.evalJavaScript(Scripting.parse(t)))return e.addLog(!1,"filter expression returns false",3),{result:!1,debugLogCollector:e}}catch(t){throw t.message="bad evaluation: "+t.message,t}return e.addLog(!0,"filter expression returns true",3),{result:!0,debugLogCollector:e}},t.prototype.verifyLimitationStrategy=function(t,e,o){var i=this,r=new c,a=[],s=!0;return e.length>0&&(e.isTaged?(e.all().forEach((function(e){if(!1!==s)if(e.max<=0)r.addLog(!0,"limitationStrategy max value <= 0",3);else if(e.tags.length>0){for(var l=u([],e.tags.getCompiledTags(),!0),d=0;d<l.length;d++)if(!t.includes(l[d]))return void r.addLog(!0,"tag '".concat(l[d],"' not found in current tags (current tags: ").concat(t.join(", "),", limitation tags: ").concat(l.join(", "),")"),3);var c=u(u([],l,!0),e.isSeparate?[o]:[],!0),g=new n.A(c).toStringKey(),h=i.randomEventHistory.getActualFiredTagCount(g);if(h>=e.max)return s=!1,void r.addLog(!1,"limitationStrategy with tags ['".concat(l.join(", "),"'] have max value ").concat(e.max," but already fired ").concat(h," times"),3);a.push(c),r.addLog(!0,"limitationStrategy with tags ['".concat(l.join(", "),"'] have max value ").concat(e.max," and already fired ").concat(h," times"),3)}else{var f=i.randomEventHistory.getActualFiredEventCount(o);if(f>=e.max)return s=!1,void r.addLog(!1,"limitationStrategy without tags have max value ".concat(e.max," but already fired ").concat(f," times"),3);r.addLog(!0,"limitationStrategy without tags have max value ".concat(e.max," and already fired ").concat(f," times"),3)}})),s&&a.length<=0&&(s=!1,r.addLog(!1,"not found any limitationStrategy where current tags cover all limitationStrategy tags (current tags: ".concat(t.join(", ")),3))):e.all().forEach((function(t){if(t.max<=0)r.addLog(!0,"limitationStrategy max value <= 0",3);else{var e=i.randomEventHistory.getActualFiredEventCount(o);if(e>=t.max)return s=!1,void r.addLog(!1,"random event have max value ".concat(t.max," but already fired ").concat(e," times"),3);r.addLog(!0,"random event have max value ".concat(t.max," and already fired ").concat(e," times"),3)}}))),{result:s,debugLogCollector:r,additionalData:{usedLimitationStrategyTags:a}}},t.prototype.verifyThreshold=function(t){var e=new c,o=0;if("number"!=typeof t||isNaN(t)||t%1!=0)try{o=Scripting.evalJavaScript(Scripting.parse(t.toString()))}catch(t){throw t.message="bad evaluation: "+t.message,t}else o=t;var n=Math.floor(100*Math.random());return n>o?(e.addLog(!1,"random value is greater than threshold (random=".concat(n," > threshold=").concat(o,")"),3),{result:!1,debugLogCollector:e}):(e.addLog(!0,"threshold passed (random="+n+" <= threshold="+o+")",3),{result:!0,debugLogCollector:e})},t}();var h=function(){return h=Object.assign||function(t){for(var e,o=1,n=arguments.length;o<n;o++)for(var i in e=arguments[o])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},h.apply(this,arguments)},f=function(t,e,o){if(o||2===arguments.length)for(var n,i=0,r=e.length;i<r;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))};const v=function(){function e(t,e,o){void 0===t&&(t="random_event"),void 0===e&&(e=/<<RandomEventDefinition>>(.*)<<\/RandomEventDefinition>>/gms),void 0===o&&(o=0);var n=this;this.randomEventTag=t,this.acquireLock=function(){return n.lock.acquire()},this.releaseLock=function(){return n.lock.release()},this.forceAcquireLock=function(){return n.lock.forceAcquire()},this.forceReleaseLock=function(){return n.lock.forceRelease()},this.loadState=function(t){return n.stateLoader.loadState(t)},this.setStateAsLoaded=function(){return n.stateLoader.forceSetIsLoadedFlag(!0)},this.resetStateLoadedFlag=function(){return n.stateLoader.resetIsLoadedFlag()},this.has=function(t){return n.randomEventCollection.has(t)},this.find=function(t){return n.randomEventCollection.find(t)},this.randomEventCollection=new r,this.randomEventHistory=new a,this.randomEventCollector=new s.A(this.randomEventCollection,t,e),this.stateLoader=new d(this.randomEventCollection,this.randomEventHistory),this.lock=new l,this.debugLogCollector=new c(o),this.constraintsVerificator=new g(this.randomEventHistory)}return e.prototype.init=function(){this.randomEventCollector.init()},Object.defineProperty(e.prototype,"isLocked",{get:function(){return this.lock.isLocked},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isForceLocked",{get:function(){return this.lock.isForce},enumerable:!1,configurable:!0}),e.prototype.enable=function(t){if(!this.randomEventCollection.has(t)){if(!Story.has(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.randomEventTag,'"'))}this.randomEventCollection.enable(t),this.randomEventHistory.enable(t)},e.prototype.disable=function(t){if(!this.randomEventCollection.has(t)){if(!Story.has(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.randomEventTag,'"'))}this.randomEventCollection.disable(t),this.randomEventHistory.disable(t)},e.prototype.enableByTag=function(t){var e=this;t=t.toLowerCase(),this.randomEventCollection.getEventsNamesByTag(t).forEach((function(t){e.randomEventCollection.enable(t),e.randomEventHistory.enable(t,!1)})),this.randomEventHistory.store()},e.prototype.disableByTag=function(t){var e=this;t=t.toLowerCase(),this.randomEventCollection.getEventsNamesByTag(t).forEach((function(t){e.randomEventCollection.disable(t),e.randomEventHistory.disable(t,!1)})),this.randomEventHistory.store()},e.prototype.resetFiredCounterByRandomEvent=function(t){if(!this.randomEventCollection.has(t)){if(!Story.has(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.randomEventTag,'"'))}this.randomEventHistory.resetRandomEventFiredCounter(t)},e.prototype.resetFiredCounterByTag=function(t){var e=this;t=t.toLowerCase(),this.randomEventHistory.resetTagFiredCounter(t,!1),this.randomEventCollection.getEventsNamesByTag(t).forEach((function(t){e.randomEventHistory.resetRandomEventFiredCounter(t,!1)})),this.randomEventCollection.getEventsNamesByLimitationStrategyTag(t).forEach((function(t){e.randomEventHistory.resetRandomEventFiredCounter(t,!1)})),this.randomEventCollection.getTagGroupsByLimitationStrategyTag(t).forEach((function(t){var o=new n.A(t).toStringKey();e.randomEventHistory.resetTagFiredCounter(o,!1)})),this.randomEventHistory.store()},e.prototype.runRandomEvent=function(t,e){if(this.debugLogCollector.clear(),e=h({isValidateIsEnable:!0,isEnable:null,isValidateFilter:!0,filter:null,isValidateLimitationStrategy:!0,limitationStrategy:null,isValidateThreshold:!0,threshold:null},null!=e?e:{}),!this.randomEventCollection.has(t)){if(!Story.has(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.randomEventTag,'"'))}var o=this.randomEventCollection.get(t);this.debugLogCollector.addLog(null,"Start random event ".concat(o.name),1),this.debugLogCollector.increaseLevel();var n=!0;if(this.lock.isLocked)return n=!1,this.debugLogCollector.addLog(null,"Skip because lock already acquired",1),{isSuccess:n,debugLogCollector:this.debugLogCollector,randomEvent:o,usedTags:[]};try{var i=o.tags.getCompiledTags(),r=this.constraintsVerificator.verify(o,e);return n=r.result,this.debugLogCollector.increaseLevel().merge(r.debugLogCollector).decreaseLevel(),{isSuccess:n,debugLogCollector:this.debugLogCollector,randomEvent:o,usedTags:o.limitationStrategy.isTaged?r.additionalData.usedLimitationStrategyTags:[i]}}catch(t){throw t}},e.prototype.runGroup=function(e,n,i){var r=this;if(e=e.toLowerCase(),this.debugLogCollector.clear(),i=h({isValidateIsEnable:!0,isEnable:null,isValidateFilter:!0,filter:null,isValidateLimitationStrategy:!0,limitationStrategy:null,isValidateThreshold:!0,threshold:null},null!=i?i:{}),!this.randomEventCollection.hasGroup(e))throw new Error('group "'.concat(e,'" does not exist'));this.debugLogCollector.addLog(null,"Start group ".concat(e),1),this.debugLogCollector.increaseLevel();var a=!0;if(this.lock.isLocked)return a=!1,this.debugLogCollector.addLog(null,"Skip because lock already acquired",1),{isSuccess:a,debugLogCollector:this.debugLogCollector};if(t.A.isNumber(n)||t.A.isString(n)){try{a=(v=this.constraintsVerificator.verifyThreshold(n)).result,this.debugLogCollector.addLog(v.result,"verify group threshold",2).increaseLevel().merge(v.debugLogCollector).decreaseLevel()}catch(t){throw t}if(!1===a)return{isSuccess:a,debugLogCollector:this.debugLogCollector};i.isValidateThreshold=!1}for(var s=0,l=[],d=this.randomEventCollection.getEventsNamesByGroup(e),c=0;c<d.length;c++){var u=d[c];if(!this.randomEventCollection.has(u)){if(!Story.has(u))throw new Error('passage "'.concat(u,'" does not exist'));throw new Error('passage "'.concat(u,'" exist but without tag "').concat(this.randomEventTag,'"'))}var g=this.randomEventCollection.get(u),f=g.groups.getByName(e);if(null===f)throw new Error("Can't find group \"".concat(e,'" in random event ').concat(g.name));this.debugLogCollector.addLog(null,"verify random event ".concat(g.name," with weight ").concat(f.weight),1),this.debugLogCollector.increaseLevel();try{var v,m=g.tags.getCompiledTags(),p=(v=this.constraintsVerificator.verify(g,i)).result;this.debugLogCollector.increaseLevel().merge(v.debugLogCollector).decreaseLevel(),p&&(s+=f.weight,l.push({isSuccess:p,randomEvent:g,usedTags:g.limitationStrategy.isTaged?v.additionalData.usedLimitationStrategyTags:[m],group:f}))}catch(t){throw t}this.debugLogCollector.decreaseLevel()}if(l.length<=0)return a=!1,this.debugLogCollector.addLog(!1,"not found any suitable random events in group",2),{isSuccess:a,debugLogCollector:this.debugLogCollector};var y=null;if(l[0].group.type===o.M.Sequential){var E=l.filter((function(t){return r.randomEventHistory.getHistoryFiredEventCount(t.randomEvent.name)<t.group.sequentialCount}));if(this.debugLogCollector.addLog(!0,"sequential search found ".concat(E.length," siutable events"),3),E.length>0)return y=E.sort((function(t,e){return t.group.sequentialIndex-e.group.sequentialIndex}))[0],this.debugLogCollector.addLog(!0,"winner random event: ".concat(y.randomEvent.name),3),{isSuccess:a,debugLogCollector:this.debugLogCollector,randomEvent:y.randomEvent,usedTags:y.usedTags,group:y.group}}var b=Math.floor(Math.random()*s);this.debugLogCollector.addLog(!0,"total weight: ".concat(s," | wittner weight: ").concat(b),3);for(var w=0;w<l.length;w++)if((b-=l[w].group.weight)<=0){y=l[w];break}return this.debugLogCollector.addLog(!0,"winner random event: ".concat(y.randomEvent.name),3),{isSuccess:a,debugLogCollector:this.debugLogCollector,randomEvent:y.randomEvent,usedTags:y.usedTags,group:y.group}},e.prototype.incrementCounters=function(t,e){var o=this;this.randomEventHistory.incrementRandomEventFiredCounter(t.name,!1),e.forEach((function(t){o.randomEventHistory.incrementTagsFiredCounter(f(f([],t,!0),[new n.A(t).toStringKey()],!1),!1)})),this.randomEventHistory.store(),this.stateLoader.forceSetIsLoadedFlag(!0)},e}()})(),RandomEventAppExport=__webpack_exports__})();

    var RandomEventApp = RandomEventAppExport.default;

    ////////////////////////////////
    // Initialize random event block
    ////////////////////////////////

    var re = new RandomEventApp(
        'random_event',
        /<<RandomEventDefinition>>(.*)<<\/RandomEventDefinition>>/gms,
        3, // max debug level
    );
    re.init();

    // TODO start: If somebody knows how to rewrite these more beautifully/correctly, please let me know :)
    $(document).on(':passageend', function() {
        re.releaseLock();
    });

    Engine = new Proxy(Engine, {
        get: function(target, prop) {
            if (prop === 'backward' || prop === 'forward') {
                jQuery.event.trigger({
                    type: ':called_' + prop,
                });
            }

            return target[prop];
        }
    });

    $(document).on(':called_backward', function() {
        re.resetStateLoadedFlag();
    });
    $(document).on(':called_forward', function() {
        re.resetStateLoadedFlag();
    });

    Config.navigation.override = (destinationPassage) => {
        if (re.isLocked && !re.has(destinationPassage)) {
            // if random event fired in <<button>> or <<link>>, return previous passage to normal history forward work
            return passage();
        }

        return destinationPassage;
    };

    Save.onLoad.add((save) => {
        if (save.state.history.length > 0) {
            var historyVariables = save.state.history[save.state.history.length-1].variables;

            re.loadState(historyVariables);
        }
        re.setStateAsLoaded();
    });
    // TODO end

    ///////////////////////////
    // Macros declaration block
    ///////////////////////////

    Macro.add('REEnable', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                re.loadState(State.variables);
                re.enable(randomEventPassageName);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later
    Macro.add('REEnableByTag', {
        handler: function() {
            if (this.args.length !== 1) {
				return this.error('Need to pass just 1 tag');
			}

            if (typeof this.args[0] === 'string') {
                return this.error('Random event tag should be a string value');
            }

            try {
                re.loadState(State.variables);
                re.enableByTag(this.args[0]);
            } catch(err) {
                this.error(err.message);
            }
        },
    });

    Macro.add('REDisable', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                re.loadState(State.variables);
                re.disable(randomEventPassageName);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later
    Macro.add('REDisableByTag', {
        handler: function() {
            if (this.args.length !== 1) {
				return this.error('Need to pass just 1 tag');
			}

            if (typeof this.args[0] === 'string') {
                return this.error('Random event tag should be a string value');
            }

            try {
                re.loadState(State.variables);
                re.disableByTag(this.args[0]);
            } catch(err) {
                this.error(err.message);
            }
        },
    });

    Macro.add('REReset', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                re.loadState(State.variables);
                re.resetFiredCounterByRandomEvent(randomEventPassageName);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later
    Macro.add('REResetByTag', {
        handler: function() {
            if (this.args.length !== 1) {
				return this.error('Need to pass just 1 tag');
			}

            if (typeof this.args[0] === 'string') {
                return this.error('Random event tag should be a string value');
            }

            try {
                re.loadState(State.variables);
                re.resetFiredCounterByTag(this.args[0]);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    Macro.add('RE', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                // TODO: maybe need to add more rewrite widget arguments
                var result = re.runRandomEvent(randomEventPassageName, {
                    threshold: this.args[1]
                });
            } catch (err) {
                this.error(err.message);
            }

            if (Config.debug) {
                var debugLog = 'RE "' + result.randomEvent.name + '"';
                if (result.debugLogCollector.debugLevel > 0) {
                    debugLog = result.debugLogCollector.toString();
                }
                this.debugView.name = 'RE "' + result.randomEvent.name + '"';
                this.debugView.title = debugLog;
                this.debugView.modes({
                    nonvoid: true,
                    hidden: false,
                    invalid: !result.isSuccess
                });

                if (result.debugLogCollector.debugLevel > 0) {
                    console.log(debugLog);
                }
            }

            if (result.isSuccess) {
                re.incrementCounters(result.randomEvent, result.usedTags);

                if (result.randomEvent.type === 'embaded') {
                    var $el = jQuery(this.output);
                    $el.wiki(Story.get(result.randomEvent.name).processText());
                } else {
                    re.acquireLock();
                    setTimeout(function() { Engine.play(result.randomEvent.name, true), Engine.minDomActionDelay });
                }
            }
        },
    });

    Macro.add('REGroup', {
        handler: function() {
            if (typeof this.args[0] === 'string') {
                return this.error('Random event group name should be a string value');
            }
            var groupName = this.args[0].toLowerCase();

            try {
                // TODO: maybe need to add more rewrite widget arguments
                var result = re.runGroup(groupName, this.args[1]);
            } catch (err) {
                this.error(err.message);
            }

            if (Config.debug) {
                var debugLog = 'REGroup "' + groupName + '"';
                if (result.debugLogCollector.debugLevel > 0) {
                    debugLog = result.debugLogCollector.toString();
                }
                this.debugView.name = 'REGroup "' + groupName + '"';
                this.debugView.title = debugLog;
                this.debugView.modes({
                    nonvoid: true,
                    hidden: false,
                    invalid: !result.isSuccess
                });

                if (result.debugLogCollector.debugLevel > 0) {
                    console.log(debugLog);
                }
            }

            if (result.isSuccess) {
                re.incrementCounters(result.randomEvent, result.usedTags);

                if (result.randomEvent.type === 'embaded') {
                    var $el = jQuery(this.output);
                    $el.wiki(Story.get(result.randomEvent.name).processText());
                } else {
                    re.acquireLock();
                    setTimeout(function() { Engine.play(result.randomEvent.name, true), Engine.minDomActionDelay });
                }
            }
        },
    });

    ///////////////////////
    // Public methods block
    ///////////////////////

    window.isHasRE = (passageName = '') => {
        return re.has(passageName);
    }

    window.isPassageRE = function() {
        return re.has(passage());
    }

    window.isPreviousRE = function() {
        return randomEventCollection.has(previous());
    }

    window.isREFired = (passageName = '', isUseHistory = true) => {
        if (isUseHistory) {
            return re.randomEventHistory.getHistoryFiredEventCount(passageName) > 0;
        }

        return re.randomEventHistory.getActualFiredEventCount(passageName) > 0;
    }

    window.isRETagFired = (tag = '', isUseHistory = true) => {
        if (isUseHistory) {
            return re.randomEventHistory.getHistoryFiredTagCount(tag) > 0;
        }

        return re.randomEventHistory.getActualFiredTagCount(tag) > 0;
    }
}());
