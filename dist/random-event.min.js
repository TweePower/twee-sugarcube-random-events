// repository: https://github.com/TweePower/twee-sugarcube-random-events

const debugLevel = 3; // max debug level

(function () {
    'use strict';

    var RandomEventAppExport;(()=>{"use strict";var e,t,a={d:(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},s={};a.r(s),a.d(s,{default:()=>T});class r{constructor(){this.lockData={isLocked:!1,isForce:!1}}acquire(){!1===this.lockData.isForce&&(this.lockData.isLocked=!0)}release(){!1===this.lockData.isForce&&(this.lockData.isLocked=!1)}forceAcquire(){this.lockData.isLocked=!0,this.lockData.isForce=!0}forceRelease(){this.lockData.isLocked=!1,this.lockData.isForce=!1}get isLocked(){return this.lockData.isLocked}get isForce(){return this.lockData.isForce}}class i{constructor(e=0){if(this.debugLevel=e,this.currentLevel=0,this.logs=[],0!==e&&1!==e&&2!==e&&3!==e)throw new Error("Debug level should be 0, 1, 2 or 3")}addLog(e,t,a,s){return this.logs.push({result:e,message:t,debugLevel:a,level:void 0===s?this.currentLevel:s}),this}merge(e){return e.all().forEach((e=>this.addLog(e.result,e.message,e.debugLevel,e.level+this.currentLevel))),this}increaseLevel(){return this.currentLevel++,this}decreaseLevel(){return this.currentLevel--,this.currentLevel<0&&(this.currentLevel=0),this}get length(){return this.logs.length}all(){return this.logs}toString(){return this.logs.filter((e=>e.debugLevel<=this.debugLevel)).map((e=>"  ".repeat(e.level)+(!0===e.result?"+ ":!1===e.result?"- ":"")+e.message)).join("\n")}clear(){return this.currentLevel=0,this.logs=[],this}}function o(e){return"string"==typeof e||e instanceof String}function n(e){return"boolean"==typeof e||e instanceof Boolean}function g(e){return"[object Array]"===Object.prototype.toString.call(e)}function u(e){return l(e)&&e%1==0}function l(e){return"number"==typeof e&&!isNaN(e)}function d(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}function h(e){return o(e)&&!/^\w+[\w_\- ]+$/.test(e)}class c{constructor(e,t,a){this.sugarcubeFacade=e,this.tagsManager=t,this.randomEventStats=a}verify(e,t,a){var s,r,o;let n=!0,g=[];const u=new i;if(!1===a.isValidateIsEnable)u.addLog(!0,"skip IsEnable verify",2);else{const t=this.verifyIsEnable(null!==(s=a.isEnabled)&&void 0!==s?s:e.isEnabled);n=t.result,u.addLog(t.result,"verify IsEnable using: "+(a.isEnabled?"rewrite configuration":"passage metadata"),2).increaseLevel().merge(t.debugLogCollector).decreaseLevel()}if(n)if(!1===a.isValidateFilter)u.addLog(!0,"skip filter verify",2);else{const t=this.verifyFilter(null!==(r=a.filter)&&void 0!==r?r:e.filter);n=t.result,u.addLog(t.result,"verify filter using: "+(a.filter?"rewrite configuration":"passage metadata"),2).increaseLevel().merge(t.debugLogCollector).decreaseLevel()}if(n){let a;a=e._isLimitationStrategiesTagged?this.verifyTaggedLimitationStrategy(e.passageName,e.limitationStrategies,t):this.verifyNotTaggedLimitationStrategy(e.passageName,e.limitationStrategies,t),n=a.result,u.addLog(a.result,"verify limitationStrategies using: 'passage metadata'",2).increaseLevel().merge(a.debugLogCollector).decreaseLevel(),g=a.additionalData.usedLimitationStrategyTags}if(n)if(!1===a.isValidateThreshold)u.addLog(!0,"skip threshold verify",2);else{const t=this.verifyThreshold(null!==(o=a.threshold)&&void 0!==o?o:e.threshold);n=t.result,u.addLog(t.result,"verify threshold using: "+(a.threshold?"rewrite configuration":"passage metadata"),2).increaseLevel().merge(t.debugLogCollector).decreaseLevel()}return{result:n,debugLogCollector:u,additionalData:{usedLimitationStrategyTags:g}}}verifyIsEnable(e){const t=e;return{result:t,debugLogCollector:(new i).addLog(t,t?"event enabled":"event disabled",3)}}verifyFilter(e){if(!0===e||!1===e)return{result:e,debugLogCollector:(new i).addLog(e,"filter expression returns "+(e?"true":"false"),3)};let t;try{t=this.sugarcubeFacade.runTeweeScript(e)}catch(e){throw e.message="bad evaluation: "+e.message,e}if(!0!==t&&!1!==t)throw new Error(`invalid filter expression return type (expected: boolean: actual: ${typeof t})`);return{result:t,debugLogCollector:(new i).addLog(t,"filter expression returns "+(t?"true":"false"),3)}}verifyTaggedLimitationStrategy(e,t,a){const s=new i,r=[];let o=!0;return t.length<=0?{result:!0,debugLogCollector:new i,additionalData:{usedLimitationStrategyTags:[]}}:(t.forEach((t=>{if(!1!==o)if(t.max<=0)s.addLog(!0,"limitationStrategy max value <= 0",3);else if(t.tags.length>0){const i=[...this.tagsManager.prepareTags(t.tags)];for(let e=0;e<i.length;e++)if(!a.includes(i[e]))return void s.addLog(!1,`tag '${i[e]}' not found in current tags`,3).increaseLevel().increaseLevel().addLog(null,`current tags   : ${a.join(", ")}`,3).addLog(null,`limitation tags: ${i.join(", ")}`,3).decreaseLevel().decreaseLevel();const n=[...i,...t.isSeparate?[e]:[]],g=this.tagsManager.convertTagsToStringKey(n),u=this.randomEventStats.getTagRunCountActual(g);if(u>=t.max)return o=!1,void s.addLog(!1,`limitationStrategy with tags ['${i.join(", ")}'] have max value ${t.max} but already fired ${u} times`,3);r.push(n),s.addLog(!0,`limitationStrategy with tags ['${i.join(", ")}'] have max value ${t.max} and already fired ${u} times`,3)}else{const a=this.randomEventStats.getPassageRunCountActual(e);if(a>=t.max)return o=!1,void s.addLog(!1,`limitationStrategy without tags have max value ${t.max} but already fired ${a} times`,3);s.addLog(!0,`limitationStrategy without tags have max value ${t.max} and already fired ${a} times`,3)}})),o&&r.length<=0&&(o=!1,s.addLog(!1,`not found any limitationStrategy where current tags cover all limitationStrategy tags (current tags: ${a.join(", ")}`,3)),{result:o,debugLogCollector:s,additionalData:{usedLimitationStrategyTags:r}})}verifyNotTaggedLimitationStrategy(e,t,a){const s=new i;let r=!0;return t.length<=0?{result:!0,debugLogCollector:new i,additionalData:{usedLimitationStrategyTags:[]}}:(t.forEach((t=>{if(t.max<=0)return void s.addLog(!0,"limitationStrategy max value <= 0",3);const a=this.randomEventStats.getPassageRunCountActual(e);if(a>=t.max)return r=!1,void s.addLog(!1,`random event have max value ${t.max} but already fired ${a} times`,3);s.addLog(!0,`random event have max value ${t.max} and already fired ${a} times`,3)})),{result:r,debugLogCollector:s,additionalData:{usedLimitationStrategyTags:[]}})}verifyThreshold(e){let t=0;if(l(e))t=e;else try{t=this.sugarcubeFacade.runTeweeScript(e.toString())}catch(e){throw e.message="bad evaluation: "+e.message,e}if(t>=100)return{result:!0,debugLogCollector:(new i).addLog(!0,"threshold is equal to or greater than 100",3)};const a=Math.floor(100*Math.random());return a>t?{result:!1,debugLogCollector:(new i).addLog(!1,`random value is greater than threshold (random=${a} > threshold=${t})`,3)}:{result:!0,debugLogCollector:(new i).addLog(!0,"threshold passed (random="+a+" <= threshold="+t+")",3)}}}!function(e){e.Random="random",e.Sequential="sequential"}(e||(e={}));class p{constructor(e){this.sugarcubeFacade=e}prepareTags(e){return e.map((e=>{if(!h(e))return e;try{return this.sugarcubeFacade.runTeweeScript(e).trim().replace(" ","__")}catch(t){throw new Error("Invalid random event scripted tag: "+e)}})).sort()}convertTagsToStringKey(e){return this.prepareTags(e).join("_")}}class y extends Error{constructor(e,t=null,a=[],s=null,r=null){super(e),this._path=[],this._expected=null,this._actual=null,this._passageName=t,this._path=a,this._expected=s,this._actual=r,Object.setPrototypeOf(this,y.prototype)}static fromPreviousError(e,t=null,a=[]){a=[...a,...e instanceof y?e.path:[]],t=null!==t?t:e instanceof y?e.passageName:null;const s=new y(e.message,t,e instanceof y?e.expected:null,e instanceof y?e.actual:null);return s.stack=e.stack,s}get passageName(){return this._passageName}get path(){return this._path}get expected(){return this._expected}get actual(){return this._actual}}class m extends y{constructor(e=null,t=[],a=null,s=null){super("Invalid type",e,t,a,s),Object.setPrototypeOf(this,y.prototype)}}class f extends y{constructor(e=null,t=[],a=null,s=null){super("Invalid value",e,t,a,s),Object.setPrototypeOf(this,y.prototype)}}class v extends y{constructor(e,t=null,a=[],s=null,r=null){super(null===e?"Valie is required":"Valie is required when "+e,t,a,s,r),Object.setPrototypeOf(this,y.prototype)}}!function(e){e.Embedded="embedded",e.Goto="goto"}(t||(t={}));class b{process(e){if(!d(e))throw new Error(`Invalid passage metadata type (expected JSON object, actual ${typeof e})`);if(!o(e.passageName))throw new Error(`Invalid passage name type (expected string, actual ${typeof e.passageName})`);e._isLimitationStrategiesTagged=!1,e._groupByNameIndex={},e._stringTags=[],e._runCountHistory=0,e._runCountActual=0,e._runCountByTagsHistory={},e._runCountByTagsActual={},this.processIsEnabled(e),this.processGroups(e),this.processFilter(e),this.processType(e),this.processThreshold(e),this.processTags(e),this.processLimitationStrategies(e)}processIsEnabled(e){if(void 0===e.isEnabled||null===e.isEnabled)e.isEnabled=!0;else if(!n(e.isEnabled))throw new m(e.passageName,["PassageMetadata","isEnabled"],"boolean",typeof e.isEnabled)}processGroups(t){if(void 0===t.groups||null===t.groups)t.groups=[];else{if(!(o(t.groups)||d(t.groups)||g(t.groups)))throw new m(t.passageName,["PassageMetadata","groups"],"string, object or array of strings or objects",typeof t.groups);(o(t.groups)||d(t.groups))&&(t.groups=[t.groups]);for(let a=0;a<t.groups.length;a++){if(o(t.groups[a]))t.groups[a]={name:t.groups[a],weight:10,type:e.Random,sequentialIndex:null,sequentialCount:null};else if(d(t.groups[a])){if(!o(t.groups[a].name))throw new m(t.passageName,["PassageMetadata","groups",a,"name"],"string",typeof t.groups[a].name);if(void 0===t.groups[a].weight||null===t.groups[a].weight)t.groups[a].weight=10;else if(!u(t.groups[a].weight))throw new m(t.passageName,["PassageMetadata","groups",a,"weight"],"integer",typeof t.groups[a].weight);if(void 0===t.groups[a].type||null===t.groups[a].type)t.groups[a].type=e.Random;else{if(!o(t.groups[a].type))throw new m(t.passageName,["PassageMetadata","groups",a,"type"],"string",typeof t.groups[a].type);if(t.groups[a].type!==e.Random&&t.groups[a].type!==e.Sequential)throw new f(t.passageName,["PassageMetadata","groups",a,"type"],`"${e.Random}" or "${e.Sequential}"`,t.groups[a].type)}if(t.groups[a].type===e.Sequential){if(void 0===t.groups[a].sequentialIndex)throw new v(`groupMetadata.type = "${e.Sequential}"`,t.passageName,["PassageMetadata","groups",a,"sequentialIndex"]);if(!u(t.groups[a].sequentialIndex))throw new m(t.passageName,["PassageMetadata","groups",a,"sequentialIndex"],"integer",typeof t.groups[a].sequentialIndex);if(void 0===t.groups[a].sequentialCount||null===t.groups[a].sequentialCount)t.groups[a].sequentialCount=1;else if(!u(t.groups[a].sequentialCount))throw new m(t.passageName,["PassageMetadata","groups",a,"sequentialCount"],"integer",typeof t.groups[a].sequentialCount)}}t._groupByNameIndex[t.groups[a].name]=a}}}processFilter(e){if(void 0===e.filter||null===e.filter)e.filter=!0;else if(!o(e.filter)&&!n(e.filter))throw new m(e.passageName,["PassageMetadata","filter"],"string or boolean",typeof e.filter)}processType(e){if(void 0===e.type||null===e.type)e.type=t.Embedded;else{if(!o(e.type))throw new m(e.passageName,["PassageMetadata","type"],"string",typeof e.type);if(e.type!==t.Embedded&&e.type!==t.Goto)throw new f(e.passageName,["PassageMetadata","type"],`"${t.Embedded}" or "${t.Goto}"`,e.type)}}processThreshold(e){if(void 0===e.threshold||null===e.threshold)e.threshold=100;else{if(!l(e.threshold)&&!o(e.threshold))throw new m(e.passageName,["PassageMetadata","threshold"],"integer or string",typeof e.threshold);l(e.threshold)&&(e.threshold<0?new y("Should equal or greater than 0",e.passageName,["PassageMetadata","threshold"]):e.threshold>100&&new y("Should equal or less than 100",e.passageName,["PassageMetadata","threshold"]))}}processTags(e){if(void 0===e.tags||null===e.tags)e.tags=[];else if(o(e.tags)||g(e.tags)){o(e.tags)&&(e.tags=[e.tags]);for(let t=0;t<e.tags.length;t++){if(!o(e.tags[t]))throw new m(e.passageName,["PassageMetadata","tags",t],"string",typeof e.tags[t]);h(e.tags[t])||e._stringTags.push(e.tags[t])}}}processLimitationStrategies(e){if(void 0===e.limitationStrategies||null===e.limitationStrategies)e.limitationStrategies=[];else{if(!d(e.limitationStrategies)&&!g(e.limitationStrategies))throw new m(e.passageName,["PassageMetadata","limitationStrategies"],"object or array",typeof e.limitationStrategies);d(e.limitationStrategies)&&(e.limitationStrategies=[e.limitationStrategies]);for(let t=0;t<e.limitationStrategies.length;t++){if(!d(e.limitationStrategies[t]))throw new m(e.passageName,["PassageMetadata","limitationStrategies",t],"object",typeof e.limitationStrategies[t]);if(!u(e.limitationStrategies[t].max))throw new m(e.passageName,["PassageMetadata","limitationStrategies",t,"max"],"integer",typeof e.limitationStrategies[t].max);if(e.limitationStrategies[t].max<0)throw new y("Should equal or greater than 0",e.passageName,["PassageMetadata","limitationStrategies",t,"max"],null,e.limitationStrategies[t].max);if(void 0===e.limitationStrategies[t].isSeparate||null===e.limitationStrategies[t].isSeparate)e.limitationStrategies[t].isSeparate=!1;else if(!n(e.limitationStrategies[t].isSeparate))throw new m(e.passageName,["PassageMetadata","limitationStrategies",t,"isSeparate"],"boolean",typeof e.limitationStrategies[t].isSeparate);if(void 0===e.limitationStrategies[t].tags||null===e.limitationStrategies[t].tags)e.limitationStrategies[t].tags=[];else if(o(e.limitationStrategies[t].tags)||g(e.limitationStrategies[t].tags)){o(e.limitationStrategies[t].tags)&&(e.limitationStrategies[t].tags=[e.limitationStrategies[t].tags]);for(let a=0;a<e.limitationStrategies[t].tags.length;a++){if(!o(e.limitationStrategies[t].tags[a]))throw new m(e.passageName,["PassageMetadata","limitationStrategies",t,"tags",a],"string",typeof e.limitationStrategies[t].tags[a]);if(h(e.limitationStrategies[t].tags[a]))throw new y("Should not contain twee scripts",e.passageName,["PassageMetadata","limitationStrategies",t,"tags",a],"string",typeof e.limitationStrategies[t].tags[a])}}e.limitationStrategies[t].tags.length>0?(e.limitationStrategies[t]._isTagged=!0,e._isLimitationStrategiesTagged=!0):e.limitationStrategies[t]._isTagged=!1}}}}const C=(e,t,a)=>{a.addMacros("REEnable",{handler:function(){if(0===this.args.length)return this.error("No random event passage name specified");var t;t="object"==typeof this.args[0]?this.args[0].link:this.args[0];try{e.enable(t)}catch(e){this.error(e.message)}}}),a.addMacros("REEnableByTag",{handler:function(){if(1!==this.args.length)return this.error("Need to pass just 1 tag");if("string"!=typeof this.args[0])return this.error("Random event tag should be a string value");try{e.enableByTag(this.args[0])}catch(e){this.error(e.message)}}}),a.addMacros("REDisable",{handler:function(){if(0===this.args.length)return this.error("No random event passage name specified");var t;t="object"==typeof this.args[0]?this.args[0].link:this.args[0];try{e.disable(t)}catch(e){this.error(e.message)}}}),a.addMacros("REDisableByTag",{handler:function(){if(1!==this.args.length)return this.error("Need to pass just 1 tag");if("string"!=typeof this.args[0])return this.error("Random event tag should be a string value");try{e.disableByTag(this.args[0])}catch(e){this.error(e.message)}}}),a.addMacros("REReset",{handler:function(){if(0===this.args.length)return this.error("No random event passage name specified");var t;t="object"==typeof this.args[0]?this.args[0].link:this.args[0];try{e.resetRunCounterByPassage(t)}catch(e){this.error(e.message)}}}),a.addMacros("REResetByTag",{handler:function(){if(1!==this.args.length)return this.error("Need to pass just 1 tag");if("string"!=typeof this.args[0])return this.error("Random event tag should be a string value");try{e.resetRunCounterByTag(this.args[0])}catch(e){this.error(e.message)}}}),a.addMacros("RE",{handler:function(){if(0===this.args.length)return this.error("No random event passage name specified");var t;t="object"==typeof this.args[0]?this.args[0].link:this.args[0];try{var a=e.runRandomEvent(t,{threshold:this.args[1]})}catch(e){this.error(e.message)}if(Config.debug){var s="";a.debugLogCollector.debugLevel>0&&(s=a.debugLogCollector.toString()),this.debugView.name='RE "'+a.passageMetadata.passageName+'"',this.debugView.title=s,this.debugView.modes({nonvoid:!0,hidden:!1,invalid:!a.isSuccess}),a.debugLogCollector.debugLevel>0&&console.log(s)}a.debugLogCollector.debugLevel>0&&(s="",s+=a.debugLogCollector.toString(),console.log(s)),a.isSuccess&&(e.incrementRunCounters(a.passageMetadata.passageName,a.usedTags),"embedded"===a.passageMetadata.type?jQuery(this.output).wiki(Story.get(a.passageMetadata.passageName).processText()):(e.acquireLock(),setTimeout((function(){Engine.play(a.passageMetadata.passageName,!0),Engine.minDomActionDelay}))))}}),a.addMacros("REGroup",{handler:function(){if("string"!=typeof this.args[0])return this.error("Random event group name should be a string value");var t=this.args[0];try{var a=e.runGroup(t,this.args[1])}catch(e){this.error(e.message)}if(Config.debug){var s='REGroup "'+t+'"';a.debugLogCollector.debugLevel>0&&(s=a.debugLogCollector.toString()),this.debugView.name='REGroup "'+t+'"',this.debugView.title=s,this.debugView.modes({nonvoid:!0,hidden:!1,invalid:!a.isSuccess}),a.debugLogCollector.debugLevel>0&&console.log(s)}a.debugLogCollector.debugLevel>0&&(s="",s+=a.debugLogCollector.toString(),console.log(s)),a.isSuccess&&(e.incrementRunCounters(a.passageMetadata.passageName,a.usedTags),"embedded"===a.passageMetadata.type?jQuery(this.output).wiki(Story.get(a.passageMetadata.passageName).processText()):(e.acquireLock(),setTimeout((function(){Engine.play(a.passageMetadata.passageName,!0),Engine.minDomActionDelay}))))}})};class L{getAllPassages(){return Story.lookup()}runTeweeScript(e){return Scripting.evalJavaScript(Scripting.parse(e))}getCurrentPassage(){return passage()}hasPassage(e){return Story.has(e)}getVariable(e){return State.variables[e]}saveVariable(e,t){State.variables[e]=t}addMacros(e,t){Macro.add(e,t)}}class S{constructor(e,t){this.passageMetadataApp=e,this.tagsManager=t,this.passagesRunCountHistory={},this.passagesRunCountActual={},this.tagsRunCountHistory={},this.tagsRunCountActual={},this._passagesByTagIndex={},this._tagsStringKeysByPassageAndTagIndex={},this._tagsStringKeysIndex={},e.onAfterAddMetadata.add((e=>{const t=e.data;t._stringTags.forEach((e=>{!o(e)||e.length<=0||(void 0===this._passagesByTagIndex[e]&&(this._passagesByTagIndex[e]=[]),this._passagesByTagIndex[e].push(t.passageName))})),t.limitationStrategies.forEach((a=>{if(g(a.tags)&&a.tags.length>0){const s=a.tags;!0===a.isSeparate&&s.push(t.passageName);const r=this.tagsManager.convertTagsToStringKey(s);void 0===this._tagsStringKeysIndex[r]&&(this._tagsStringKeysIndex[r]=[]),!0===a.isSeparate&&s.push(t.passageName),a.tags.forEach((a=>{!o(a)||a.length<=0||(void 0===this._passagesByTagIndex[a]&&(this._passagesByTagIndex[a]=[]),this._passagesByTagIndex[a].includes(e.passageName)||this._passagesByTagIndex[a].push(e.passageName),void 0===this._tagsStringKeysByPassageAndTagIndex[a]&&(this._tagsStringKeysByPassageAndTagIndex[a]={}),void 0===this._tagsStringKeysByPassageAndTagIndex[a][t.passageName]&&(this._tagsStringKeysByPassageAndTagIndex[a][t.passageName]=[]),this._tagsStringKeysByPassageAndTagIndex[a][t.passageName].push(r),this._tagsStringKeysIndex[r].includes(a)||this._tagsStringKeysIndex[r].push(a))}))}}))})),e.onBeforeRestore.add((e=>{console.log(e);const t={};void 0!==e.__tags&&(e.__tags.forEach(((e,a)=>{t[a]=e})),delete e.__tags),this.passagesRunCountHistory={},this.passagesRunCountActual={},this.tagsRunCountHistory={},this.tagsRunCountActual={},Object.keys(e).forEach((a=>{var s,r;const i=e[a];void 0===i._runCountActual&&(i._runCountActual=0),void 0===i._runCountHistory&&(i._runCountHistory=0),void 0===i._runCountByTagsActual&&(i._runCountByTagsActual={}),void 0===i._runCountByTagsHistory&&(i._runCountByTagsHistory={}),void 0!==i.s&&(i._runCountActual=null!==(s=i.s.a)&&void 0!==s?s:i._runCountActual,i._runCountHistory=null!==(r=i.s.h)&&void 0!==r?r:i._runCountHistory,void 0!==i.s.t&&Object.keys(i.s.t).map((e=>parseInt(e))).forEach((e=>{void 0!==i.s.t[e].a&&(i._runCountByTagsActual[t[e]]=i.s.t[e].a),void 0!==i.s.t[e].h&&(i._runCountByTagsHistory[t[e]]=i.s.t[e].h)})),delete i.s),l(i._runCountActual)&&(this.passagesRunCountActual[a]=i._runCountActual),l(i._runCountHistory)&&(this.passagesRunCountHistory[a]=i._runCountHistory),d(i._runCountByTagsActual)&&Object.keys(i._runCountByTagsActual).forEach((e=>{void 0===this.tagsRunCountActual[e]&&(this.tagsRunCountActual[e]=0),this.tagsRunCountActual[e]+=i._runCountByTagsActual[e]})),d(i._runCountByTagsHistory)&&Object.keys(i._runCountByTagsHistory).forEach((e=>{void 0===this.tagsRunCountHistory[e]&&(this.tagsRunCountHistory[e]=0),this.tagsRunCountHistory[e]+=i._runCountByTagsHistory[e]}))}))})),e.onBeforeStore.add((e=>{let t=0;const a={};Object.keys(e).forEach((s=>{const r=e[s],i={};if(l(r._runCountActual)&&(i.a=r._runCountActual,delete r._runCountActual),l(r._runCountHistory)&&(i.h=r._runCountHistory,delete r._runCountHistory),d(r._runCountByTagsActual)){const e=Object.keys(r._runCountByTagsActual);e.length>0&&(i.t={},e.forEach((e=>{void 0===a[e]&&(a[e]=t,t++),void 0===i.t[a[e]]&&(i.t[a[e]]={}),i.t[a[e]].a=r._runCountByTagsActual[e]}))),delete r._runCountByTagsActual}if(d(r._runCountByTagsHistory)){const e=Object.keys(r._runCountByTagsHistory);e.length>0&&(void 0===i.t&&(i.t={}),e.forEach((e=>{void 0===a[e]&&(a[e]=t,t++),void 0===i.t[a[e]]&&(i.t[a[e]]={}),i.t[a[e]].h=r._runCountByTagsHistory[e]}))),delete r._runCountByTagsHistory}Object.keys(i).length>0&&(r.s=i)})),t>0&&(e.__tags=Object.keys(a))}))}incrementPassageRunCount(e,t=1,a=!1){const s=this.passageMetadataApp.get(e),r=s.data._runCountHistory+t,i=s.data._runCountActual+t;s.setValue("_runCountHistory",r),s.setValue("_runCountActual",i),this.passagesRunCountHistory[e]=r,this.passagesRunCountActual[e]=i,!0===a&&this.passageMetadataApp.storeState()}incrementTagsRunCount(e,t,a=1,s=!1){const r=this.passageMetadataApp.get(e),i=r.data._runCountByTagsHistory,o=r.data._runCountByTagsActual;g(t)&&t.length>0&&t.forEach((e=>{if(g(e)&&e.length>0){const t=[...e].filter(((e,t,a)=>a.indexOf(e)===t)),s=this.tagsManager.convertTagsToStringKey(e);t.forEach((e=>{""!==e&&(i[e]=void 0===i[e]?a:i[e]+a,o[e]=void 0===o[e]?a:o[e]+a,this.tagsRunCountHistory[e]=void 0===this.tagsRunCountHistory[e]?a:this.tagsRunCountHistory[e]+a,this.tagsRunCountActual[e]=void 0===this.tagsRunCountActual[e]?a:this.tagsRunCountActual[e]+a)})),""!==s&&(i[s]=void 0===i[s]?a:i[s]+a,o[s]=void 0===o[s]?a:o[s]+a,this.tagsRunCountHistory[s]=void 0===this.tagsRunCountHistory[s]?a:this.tagsRunCountHistory[s]+a,this.tagsRunCountActual[s]=void 0===this.tagsRunCountActual[s]?a:this.tagsRunCountActual[s]+a)}})),r.setValue("_runCountByTagsHistory",i),r.setValue("_runCountByTagsActual",o),!0===s&&this.passageMetadataApp.storeState()}resetPassageRunCount(e,t=!1){this.passageMetadataApp.get(e).setValue("_runCountActual",0),this.passagesRunCountActual[e]=0,!0===t&&this.passageMetadataApp.storeState()}resetTagsRunCount(e,t=!1){Array.isArray(e)||(e=[e]),g(e)&&e.forEach((e=>{if(!o(e))throw new Error("Tag shouldb be string");void 0!==this.tagsRunCountActual[e]&&delete this.tagsRunCountActual[e],g(this._passagesByTagIndex[e])&&this._passagesByTagIndex[e].forEach((t=>{const a=this.passageMetadataApp.get(t);a.setValue("_runCountActual",0),delete this.passagesRunCountActual[t];const s={...a.data._runCountByTagsActual};delete s[e],a.setValue("_runCountByTagsActual",s)})),d(this._tagsStringKeysByPassageAndTagIndex[e])&&Object.keys(this._tagsStringKeysByPassageAndTagIndex[e]).forEach((t=>{if(g(this._tagsStringKeysByPassageAndTagIndex[e][t])){const a=this.passageMetadataApp.get(t);this._tagsStringKeysByPassageAndTagIndex[e][t].forEach((e=>{const t={...a.data._runCountByTagsActual};void 0!==t[e]&&(void 0!==this._tagsStringKeysIndex[e]&&this._tagsStringKeysIndex[e].forEach((e=>{void 0!==t[e]&&delete t[e],void 0!==this.tagsRunCountActual[e]&&delete this.tagsRunCountActual[e]})),delete t[e]),a.setValue("_runCountByTagsActual",t),void 0!==this.tagsRunCountActual[e]&&delete this.tagsRunCountActual[e]}))}}))})),!0===t&&this.passageMetadataApp.storeState()}getPassageRunCountActual(e){var t;return null!==(t=this.passagesRunCountActual[e])&&void 0!==t?t:0}getPassageRunCountHistory(e){var t;return null!==(t=this.passagesRunCountHistory[e])&&void 0!==t?t:0}getTagRunCountActual(e){var t;return null!==(t=this.tagsRunCountActual[e])&&void 0!==t?t:0}getTagRunCountHistory(e){var t;return null!==(t=this.tagsRunCountHistory[e])&&void 0!==t?t:0}}class T{constructor(e,t=0){this.passageMetadataApp=e,this._passagesByTagIndex={},this._passagesByGroupIndex={},this.acquireLock=()=>this.lock.acquire(),this.releaseLock=()=>this.lock.release(),this.forceAcquireLock=()=>this.lock.forceAcquire(),this.forceReleaseLock=()=>this.lock.forceRelease(),this.has=e=>this.passageMetadataApp.has(e),this.find=e=>this.passageMetadataApp.find(e),this.sugarcubeFacade=new L,this.tagsManager=new p(this.sugarcubeFacade),this.lock=new r,this.debugLogCollector=new i(t),this.randomEventStats=new S(e,this.tagsManager),this.constraintsVerificator=new c(this.sugarcubeFacade,this.tagsManager,this.randomEventStats);const a=new b;e.onBeforeAddMetadata.add((e=>{try{a.process(e)}catch(e){if(e instanceof y){let t=e.message;e.path.length>0&&(t+=" ",e.path.forEach(((e,a)=>{0===a||"["===e[0]?t+=e:t+="."+e})));let a=[];throw null!==e.expected&&a.push("expected "+e.expected),null!==e.actual&&a.push("actual "+e.actual),new Error(`${t}${a.join.length>0?` (${a.join(", ")})`:""}`)}throw e}})),e.onAfterAddMetadata.add((e=>{const t=e.data;t.tags.length>0&&t.tags.forEach((e=>{h(e)||(void 0===this._passagesByTagIndex[e]&&(this._passagesByTagIndex[e]=[]),this._passagesByTagIndex[e].push(t.passageName))})),t.groups.length>0&&t.groups.forEach((e=>{void 0===this._passagesByGroupIndex[e.name]&&(this._passagesByGroupIndex[e.name]=[]),this._passagesByGroupIndex[e.name].push(t.passageName)}))})),e.onBeforeRestore.add((e=>{Object.keys(e).forEach((t=>{const a=e[t];void 0!==a.e&&(a.isEnabled=a.e,delete a.e)}))})),e.onBeforeStore.add((e=>{Object.keys(e).forEach((t=>{const a=e[t];void 0!==a.isEnabled&&(a.e=a.isEnabled,delete a.isEnabled)}))})),C(this,0,this.sugarcubeFacade)}get isLocked(){return this.lock.isLocked}get isForceLocked(){return this.lock.isForce}enable(e){if(!this.passageMetadataApp.has(e)){if(!this.sugarcubeFacade.hasPassage(e))throw new Error(`passage "${e}" does not exist`);throw"byTag"===this.passageMetadataApp.mode?new Error(`passage "${e}" exist but without tag "${this.passageMetadataApp.modeParams.filterTag}"`):new Error(`passage "${e}" does'n contain metadata`)}this.passageMetadataApp.get(e).setValue("isEnabled",!0),this.passageMetadataApp.storeState()}disable(e){if(!this.passageMetadataApp.has(e)){if(!this.sugarcubeFacade.hasPassage(e))throw new Error(`passage "${e}" does not exist`);throw"byTag"===this.passageMetadataApp.mode?new Error(`passage "${e}" exist but without tag "${this.passageMetadataApp.modeParams.filterTag}"`):new Error(`passage "${e}" does'n contain metadata`)}this.passageMetadataApp.get(e).setValue("isEnabled",!1),this.passageMetadataApp.storeState()}enableByTag(e){g(this._passagesByTagIndex[e])&&(this._passagesByTagIndex[e].forEach((e=>{this.passageMetadataApp.get(e).setValue("isEnabled",!0)})),this.passageMetadataApp.storeState())}disableByTag(e){g(this._passagesByTagIndex[e])&&(this._passagesByTagIndex[e].forEach((e=>{this.passageMetadataApp.get(e).setValue("isEnabled",!1)})),this.passageMetadataApp.storeState())}runRandomEvent(e,t){if(this.debugLogCollector.clear(),t={isValidateIsEnable:!0,isEnabled:null,isValidateFilter:!0,filter:null,isValidateLimitationStrategy:!0,limitationStrategy:null,isValidateThreshold:!0,threshold:null,...null!=t?t:{}},!this.passageMetadataApp.has(e)){if(!this.sugarcubeFacade.hasPassage(e))throw new Error(`passage "${e}" does not exist`);throw new Error(`passage "${e}" exist but without tag "${this.passageMetadataApp.modeParams.filterTag}"`)}const a=this.passageMetadataApp.get(e).data;this.debugLogCollector.addLog(null,`Start random event ${a.passageName}`,1),this.debugLogCollector.increaseLevel();let s=!0;if(this.lock.isLocked)return s=!1,this.debugLogCollector.addLog(null,"Skip because lock already acquired",1),{isSuccess:s,debugLogCollector:this.debugLogCollector,passageMetadata:a,usedTags:[]};try{const e=this.tagsManager.prepareTags(a.tags),s=this.constraintsVerificator.verify(a,e,t);return this.debugLogCollector.addLog(null,"Verify:",2).increaseLevel().merge(s.debugLogCollector).decreaseLevel(),{isSuccess:s.result,debugLogCollector:this.debugLogCollector,passageMetadata:a,usedTags:a._isLimitationStrategiesTagged?s.additionalData.usedLimitationStrategyTags:[e]}}catch(e){throw e}}runGroup(t,a,s){if(this.debugLogCollector.clear(),s={isValidateIsEnable:!0,isEnable:null,isValidateFilter:!0,filter:null,isValidateLimitationStrategy:!0,limitationStrategy:null,isValidateThreshold:!0,threshold:null,...null!=s?s:{}},!g(this._passagesByGroupIndex[t]))throw new Error(`group "${t}" does not exist`);this.debugLogCollector.addLog(null,`Start group ${t}`,1),this.debugLogCollector.increaseLevel();let r=!0;if(this.lock.isLocked)return r=!1,this.debugLogCollector.addLog(null,"Skip because lock already acquired",1),{isSuccess:r,debugLogCollector:this.debugLogCollector};if(l(a)||o(a)){try{const e=this.constraintsVerificator.verifyThreshold(a);r=e.result,this.debugLogCollector.addLog(null,"Verify group threshold",2).increaseLevel().merge(e.debugLogCollector).decreaseLevel()}catch(e){throw e}if(!1===r)return{isSuccess:r,debugLogCollector:this.debugLogCollector};s.isValidateThreshold=!1}this.debugLogCollector.increaseLevel().addLog(null,"Verify random events in group",1).increaseLevel();let i=0;const n=[];for(let e=0;e<this._passagesByGroupIndex[t].length;e++){const a=this._passagesByGroupIndex[t][e],r=this.passageMetadataApp.get(a).data,o=r.groups[r._groupByNameIndex[t]];this.debugLogCollector.addLog(null,`Random event ${r.passageName} with weight ${o.weight}`,1).increaseLevel();try{const e=this.tagsManager.prepareTags(r.tags),t=this.constraintsVerificator.verify(r,e,s),a=t.result;this.debugLogCollector.addLog(null,"Verify",2).increaseLevel().merge(t.debugLogCollector).decreaseLevel(),a&&(i+=o.weight,n.push({isSuccess:a,passageMetadata:r,usedTags:r._isLimitationStrategiesTagged?t.additionalData.usedLimitationStrategyTags:[e],group:o}))}catch(e){throw e}this.debugLogCollector.decreaseLevel()}if(n.length<=0)return r=!1,this.debugLogCollector.addLog(!1,"not found any suitable random events in group",2),{isSuccess:r,debugLogCollector:this.debugLogCollector};let u=null;if(n[0].group.type===e.Sequential){this.debugLogCollector.addLog(!0,"Find winner event",2).increaseLevel();const e=n.filter((e=>this.randomEventStats.getPassageRunCountHistory(e.passageMetadata.passageName)<e.group.sequentialCount));if(this.debugLogCollector.addLog(!0,`sequential search found ${e.length} siutable events`,3),e.length>0)return u=e.sort(((e,t)=>e.group.sequentialIndex-t.group.sequentialIndex))[0],this.debugLogCollector.addLog(!0,`winner random event: ${u.passageMetadata.passageName}`,3),{isSuccess:r,debugLogCollector:this.debugLogCollector,passageMetadata:u.passageMetadata,usedTags:u.usedTags,group:u.group}}let d=Math.floor(Math.random()*i);this.debugLogCollector.addLog(!0,`total weight: ${i} | wittner weight: ${d}`,3);for(let e=0;e<n.length;e++)if(d-=n[e].group.weight,d<=0){u=n[e];break}return this.debugLogCollector.addLog(!0,`winner random event: ${u.passageMetadata.passageName}`,3),{isSuccess:r,debugLogCollector:this.debugLogCollector,passageMetadata:u.passageMetadata,usedTags:u.usedTags,group:u.group}}incrementRunCounters(e,t){this.randomEventStats.incrementPassageRunCount(e),this.randomEventStats.incrementTagsRunCount(e,t),this.passageMetadataApp.storeState()}resetRunCounterByPassage(e){this.randomEventStats.resetPassageRunCount(e),this.passageMetadataApp.storeState()}resetRunCounterByTag(e){this.randomEventStats.resetTagsRunCount(e),this.passageMetadataApp.storeState()}}RandomEventAppExport=s})();
    var RandomEventApp = RandomEventAppExport.default;

    function initialize() {
        var randomEventApp = new RandomEventApp(
            window.passageMetadataApp,
            debugLevel,
        );

        $(document).on(':passageend', function() {
            randomEventApp.releaseLock();
        });

        Config.navigation.override = (destinationPassage) => {
            if (randomEventApp.isLocked && !randomEventApp.has(destinationPassage)) {
                // if random event fired in <<button>> or <<link>>, return previous passage to normal history forward work
                return realCurrentPassage ?? passage();
            }

            return destinationPassage;
        };

        window.randomEventApp = randomEventApp;
    }

    window.addEventListener('passage-metadata-app-initialized', () => {
        initialize();
    });
    if (window.passageMetadataApp !== undefined) {
        initialize();
    }
}());
