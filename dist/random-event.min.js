// repository: https://github.com/TweePower/twee-sugarcube-random-events
(function () {
    'use strict';

var RandomEventAppExport;(()=>{"use strict";var __webpack_modules__={284:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(766),PassageMetadataCollector=function(){function PassageMetadataCollector(t,e,a,r){void 0===e&&(e=/<<PassageMetadata>>(.*)<<\/PassageMetadata>>/gms),void 0===a&&(a="byTag"),void 0===r&&(r={filterTag:"passage_metadata"}),this.sugarcubeFacade=t,this.passageMetadataRegex=e,this.mode=a,this.modeParams=r}return PassageMetadataCollector.prototype.collect=function(t,e){var a=this,r=this.sugarcubeFacade.getAllPassages();if("byTag"===this.mode){if("string"!=typeof this.modeParams.filterTag)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_0__.A("modeParams.filterTag should be string");r=r.filter((function(t){return t.tags.includes(a.modeParams.filterTag)}))}r.forEach((function(r){a.passageMetadataRegex.lastIndex=0;var o=a.passageMetadataRegex.exec(r.element.textContent);if("byTag"===a.mode&&null===o)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_0__.A("Passage metadata not found in ".concat(r.title));try{var i=a.createPassageMetadataObject(o[1]);i.name=r.title,t.add(e.create(i))}catch(t){throw _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_0__.A.fromPreviousError(t,{passage:r.title})}r.element.textContent=r.element.textContent.replace(o[0],"")}))},PassageMetadataCollector.prototype.createPassageMetadataObject=function(passageMetadata){var passageMetadataEvalResult;try{if(eval("passageMetadataEvalResult = "+passageMetadata),"object"!=typeof passageMetadataEvalResult||Array.isArray(passageMetadataEvalResult)||null===passageMetadataEvalResult)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_0__.A("Passage metadata JSON should contain object")}catch(t){throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_0__.A("Invalid passage metadata JSON: ".concat(t.message))}return passageMetadataEvalResult},PassageMetadataCollector}();const __WEBPACK_DEFAULT_EXPORT__=PassageMetadataCollector},766:(t,e,a)=>{a.d(e,{A:()=>n});var r,o=(r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])},r(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function a(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}),i=function(){return i=Object.assign||function(t){for(var e,a=1,r=arguments.length;a<r;a++)for(var o in e=arguments[a])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},i.apply(this,arguments)};const n=function(t){function e(a,r){void 0===r&&(r={});var o=t.call(this,a)||this;return o.scope={},o.scope=r,Object.setPrototypeOf(o,e.prototype),o}return o(e,t),e.fromPreviousError=function(t,a){void 0===a&&(a={});var r=new e(t.message);return r.stack=t.stack,r.scope=i(i({},a),t instanceof e?t.scope:{}),r},e}(Error)}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var a=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](a,a.exports,__webpack_require__),a.exports}__webpack_require__.d=(t,e)=>{for(var a in e)__webpack_require__.o(e,a)&&!__webpack_require__.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>A});const t=function(){function t(){}return t.isString=function(t){return"string"==typeof t||t instanceof String},t.isBoolean=function(t){return"boolean"==typeof t||t instanceof Boolean},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isInteger=function(e){return t.isNumber(e)&&e%1==0},t.isFloat=function(e){return t.isNumber(e)&&e%1!=0},t.isNumber=function(t){return"number"==typeof t&&!isNaN(t)},t.isStringInteger=function(e){return t.isString(e)&&!isNaN(e)&&t.isInteger(parseFloat(e))},t.isStringFloat=function(e){return t.isString(e)&&!isNaN(e)&&t.isFloat(parseFloat(e))},t.isStringNumber=function(e){return t.isString(e)&&!isNaN(e)&&t.isNumber(parseFloat(e))},t.isObject=function(t){return"object"==typeof t&&!Array.isArray(t)&&null!==t},t}(),e=function(){function t(t){this.sugarcubeFacade=t,this.actualFiredEvents={},this.actualFiredTags={},this.historyFiredEvents={},this.historyFiredTags={},this.forceEventStatus={}}return t.prototype.loadFromSerilizedString=function(t){var e=this,a=JSON.parse(t);Object.keys(a.e).forEach((function(t){void 0!==a.e[t].a&&(e.actualFiredEvents[t]=a.e[t].a),void 0!==a.e[t].h&&(e.historyFiredEvents[t]=a.e[t].h),void 0!==a.e[t].s&&(e.forceEventStatus[t]=1===a.e[t].s)})),Object.keys(a.t).forEach((function(t){void 0!==a.t[t].a&&(e.actualFiredTags[t]=a.t[t].a),void 0!==a.t[t].h&&(e.historyFiredTags[t]=a.t[t].h)}))},t.prototype.serialize=function(){var t=this,e={e:{},t:{}};return Object.keys(this.actualFiredEvents).forEach((function(a){void 0===e.e[a]&&(e.e[a]={}),e.e[a].a=t.actualFiredEvents[a]})),Object.keys(this.historyFiredEvents).forEach((function(a){void 0===e.e[a]&&(e.e[a]={}),e.e[a].h=t.historyFiredEvents[a]})),Object.keys(this.forceEventStatus).forEach((function(a){void 0===e.e[a]&&(e.e[a]={}),e.e[a].s=!0===t.forceEventStatus[a]?1:0})),Object.keys(this.actualFiredTags).forEach((function(a){void 0===e.t[a]&&(e.t[a]={}),e.t[a].a=t.actualFiredTags[a]})),Object.keys(this.historyFiredTags).forEach((function(a){void 0===e.t[a]&&(e.t[a]={}),e.t[a].h=t.historyFiredTags[a]})),JSON.stringify(e)},t.prototype.store=function(){this.sugarcubeFacade.saveVariable("randomEventHistory",this.serialize())},t.prototype.setActualRandomEventFiredCounter=function(t,e){t=t.toLowerCase(),this.actualFiredEvents[t]=e},t.prototype.setActualTagFiredCounter=function(t,e){t=t.toLowerCase(),this.actualFiredTags[t]=e},t.prototype.setHistoryRandomEventFiredCounter=function(t,e){t=t.toLowerCase(),this.historyFiredEvents[t]=e},t.prototype.setHistoryTagFiredCounter=function(t,e){t=t.toLowerCase(),this.historyFiredTags[t]=e},t.prototype.enable=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),this.forceEventStatus[t]=!0,e&&this.store()},t.prototype.disable=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),this.forceEventStatus[t]=!1,e&&this.store()},t.prototype.incrementRandomEventFiredCounter=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),this.actualFiredEvents[t]=void 0===this.actualFiredEvents[t]?1:this.actualFiredEvents[t]+1,this.historyFiredEvents[t]=void 0===this.historyFiredEvents[t]?1:this.historyFiredEvents[t]+1,e&&this.store()},t.prototype.incrementTagsFiredCounter=function(t,e){var a=this;void 0===e&&(e=!0),null!==t&&(t.filter((function(t,e,a){return a.indexOf(t)===e})).forEach((function(t){t=t.toLowerCase(),a.actualFiredTags[t]=void 0===a.actualFiredTags[t]?1:a.actualFiredTags[t]+1,a.historyFiredTags[t]=void 0===a.historyFiredTags[t]?1:a.historyFiredTags[t]+1})),e&&this.store())},t.prototype.resetRandomEventFiredCounter=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),void 0!==this.actualFiredEvents[t]&&delete this.actualFiredEvents[t],e&&this.store()},t.prototype.resetTagFiredCounter=function(t,e){void 0===e&&(e=!0),t=t.toLowerCase(),void 0!==this.actualFiredTags[t]&&delete this.actualFiredTags[t],e&&this.store()},t.prototype.getActualFiredEventCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.actualFiredEvents[t])&&void 0!==e?e:0},t.prototype.getActualFiredTagCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.actualFiredTags[t])&&void 0!==e?e:0},t.prototype.getHistoryFiredEventCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.historyFiredEvents[t])&&void 0!==e?e:0},t.prototype.getHistoryFiredTagCount=function(t){var e;return t=t.toLowerCase(),null!==(e=this.historyFiredTags[t])&&void 0!==e?e:0},t}(),a=function(){function t(){this.lockData={isLocked:!1,isForce:!1}}return t.prototype.acquire=function(){!1===this.lockData.isForce&&(this.lockData.isLocked=!0)},t.prototype.release=function(){!1===this.lockData.isForce&&(this.lockData.isLocked=!1)},t.prototype.forceAcquire=function(){this.lockData.isLocked=!0,this.lockData.isForce=!0},t.prototype.forceRelease=function(){this.lockData.isLocked=!1,this.lockData.isForce=!1},Object.defineProperty(t.prototype,"isLocked",{get:function(){return this.lockData.isLocked},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isForce",{get:function(){return this.lockData.isForce},enumerable:!1,configurable:!0}),t}(),r=function(){function e(t,e){this.passageMetadataCollection=t,this.history=e,this.isLoaded=!1}return e.prototype.forceSetIsLoadedFlag=function(t){this.isLoaded=t},e.prototype.resetIsLoadedFlag=function(){this.isLoaded=!1},e.prototype.loadState=function(t){var e=this;this.isLoaded||(this.oldLoadState(t),this.isLoaded||void 0!==t.randomEventHistory&&(this.history.loadFromSerilizedString(t.randomEventHistory),Object.keys(this.history.forceEventStatus).forEach((function(t){e.history.forceEventStatus[t]?e.passageMetadataCollection.enable(t):e.passageMetadataCollection.disable(t)})),this.isLoaded=!0))},e.prototype.oldLoadState=function(e){var a=this;if(!this.isLoaded){if(void 0!==e.randomEventFiredEvents){var r=JSON.parse(e.randomEventFiredEvents);Object.keys(r).forEach((function(e){""!==e&&(t.isInteger(r[e])&&r[e]>0?(a.history.setActualRandomEventFiredCounter(e.toLowerCase(),r[e]),a.history.setHistoryRandomEventFiredCounter(e.toLowerCase(),r[e])):a.history.setHistoryRandomEventFiredCounter(e.toLowerCase(),1))})),delete e.randomEventFiredEvents,this.isLoaded=!0}if(void 0!==e.randomEventFiredTags){var o=JSON.parse(e.randomEventFiredTags);Object.keys(o).forEach((function(e){""!==e&&(t.isInteger(o[e])&&o[e]>0?(a.history.setActualTagFiredCounter(e.toLowerCase(),o[e]),a.history.setHistoryTagFiredCounter(e.toLowerCase(),o[e])):a.history.setHistoryTagFiredCounter(e.toLowerCase(),1))})),delete e.randomEventFiredTags,this.isLoaded=!0}if(void 0!==e.randomEventEnabledEvents){var i=JSON.parse(e.randomEventEnabledEvents);t.isArray(i)&&i.forEach((function(t){a.passageMetadataCollection.has(t)&&(a.passageMetadataCollection.enable(t),a.history.enable(t,!1))})),delete e.randomEventEnabledEvents,this.isLoaded=!0}if(void 0!==e.randomEventDisabledEvents){var n=JSON.parse(e.randomEventDisabledEvents);t.isArray(n)&&n.forEach((function(t){a.passageMetadataCollection.has(t)&&(a.passageMetadataCollection.disable(t),a.history.disable(t,!1))})),delete e.randomEventDisabledEvents,this.isLoaded=!0}this.isLoaded&&this.history.store()}},e}(),o=function(){function t(t){if(void 0===t&&(t=0),this.debugLevel=t,this.currentLevel=0,this.logs=[],0!==t&&1!==t&&2!==t&&3!==t)throw new Error("Debug level should be 0, 1, 2 or 3")}return t.prototype.addLog=function(t,e,a,r){return this.logs.push({result:t,message:e,debugLevel:a,level:void 0===r?this.currentLevel:r}),this},t.prototype.merge=function(t){var e=this;return t.all().forEach((function(t){return e.addLog(t.result,t.message,t.debugLevel,t.level+e.currentLevel)})),this},t.prototype.increaseLevel=function(){return this.currentLevel++,this},t.prototype.decreaseLevel=function(){return this.currentLevel--,this.currentLevel<0&&(this.currentLevel=0),this},Object.defineProperty(t.prototype,"length",{get:function(){return this.logs.length},enumerable:!1,configurable:!0}),t.prototype.all=function(){return this.logs},t.prototype.toString=function(){var t=this;return this.logs.filter((function(e){return e.debugLevel<=t.debugLevel})).map((function(t){return"  ".repeat(t.level)+(!0===t.result?"+ ":!1===t.result?"- ":"")+t.message})).join("\n")},t.prototype.clear=function(){return this.currentLevel=0,this.logs=[],this},t}();var i=function(t,e,a){if(a||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))};const n=function(){function t(t,e,a){this.sugarcubeFacade=t,this.tagsManager=e,this.history=a}return t.prototype.verify=function(t,e){var a,r,i,n,s,c=!0,u=[],l=new o,d=this.tagsManager.prepareTags(t.tags);return!0===e.isValidateIsEnable?(c=(s=this.verifyIsEnable(null!==(a=e.isEnable)&&void 0!==a?a:t.isEnabled)).result,l.addLog(s.result,"verify IsEnable using: ".concat(e.isEnable?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(s.debugLogCollector).decreaseLevel()):l.addLog(!0,"skip IsEnable verify",2),c&&(!0===e.isValidateFilter?(c=(s=this.verifyFilter(null!==(r=e.filter)&&void 0!==r?r:t.filter)).result,l.addLog(s.result,"verify filter using: ".concat(e.filter?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(s.debugLogCollector).decreaseLevel()):l.addLog(!0,"skip filter verify",2)),c&&(e.isValidateLimitationStrategy?(c=(s=this.verifyLimitationStrategy(d,null!==(i=e.limitationStrategy)&&void 0!==i?i:t.limitationStrategy,t.name)).result,l.addLog(s.result,"verify limitationStrategy using: ".concat(e.limitationStrategy?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(s.debugLogCollector).decreaseLevel(),u=s.additionalData.usedLimitationStrategyTags):l.addLog(!0,"skip limitationStrategy verify",2)),c&&(e.isValidateThreshold?(c=(s=this.verifyThreshold(null!==(n=e.threshold)&&void 0!==n?n:t.threshold)).result,l.addLog(s.result,"verify threshold using: ".concat(e.threshold?"rewrite configuration":"definition configuration"),2).increaseLevel().merge(s.debugLogCollector).decreaseLevel()):l.addLog(!0,"skip threshold verify",2)),{result:c,debugLogCollector:l,additionalData:{usedLimitationStrategyTags:u}}},t.prototype.verifyIsEnable=function(t){return{result:t,debugLogCollector:(new o).addLog(t,t?"event enabled":"event disabled",3)}},t.prototype.verifyFilter=function(t){var e=new o;if(null!==t)try{if(!this.sugarcubeFacade.runTeweeScript(t))return e.addLog(!1,"filter expression returns false",3),{result:!1,debugLogCollector:e}}catch(t){throw t.message="bad evaluation: "+t.message,t}return e.addLog(!0,"filter expression returns true",3),{result:!0,debugLogCollector:e}},t.prototype.verifyLimitationStrategy=function(t,e,a){var r=this,n=new o,s=[],c=!0;return e.length>0&&(e.isTaged?(e.all().forEach((function(e){if(!1!==c)if(e.max<=0)n.addLog(!0,"limitationStrategy max value <= 0",3);else if(e.tags.length>0){for(var o=i([],r.tagsManager.prepareTags(e.tags),!0),u=0;u<o.length;u++)if(!t.includes(o[u]))return void n.addLog(!1,"tag '".concat(o[u],"' not found in current tags"),3).increaseLevel().increaseLevel().addLog(null,"current tags   : ".concat(t.join(", ")),3).addLog(null,"limitation tags: ".concat(o.join(", ")),3).decreaseLevel().decreaseLevel();var l=i(i([],o,!0),e.isSeparate?[a]:[],!0),d=r.tagsManager.convertTagsToStringKey(l),g=r.history.getActualFiredTagCount(d);if(g>=e.max)return c=!1,void n.addLog(!1,"limitationStrategy with tags ['".concat(o.join(", "),"'] have max value ").concat(e.max," but already fired ").concat(g," times"),3);s.push(l),n.addLog(!0,"limitationStrategy with tags ['".concat(o.join(", "),"'] have max value ").concat(e.max," and already fired ").concat(g," times"),3)}else{var h=r.history.getActualFiredEventCount(a);if(h>=e.max)return c=!1,void n.addLog(!1,"limitationStrategy without tags have max value ".concat(e.max," but already fired ").concat(h," times"),3);n.addLog(!0,"limitationStrategy without tags have max value ".concat(e.max," and already fired ").concat(h," times"),3)}})),c&&s.length<=0&&(c=!1,n.addLog(!1,"not found any limitationStrategy where current tags cover all limitationStrategy tags (current tags: ".concat(t.join(", ")),3))):e.all().forEach((function(t){if(t.max<=0)n.addLog(!0,"limitationStrategy max value <= 0",3);else{var e=r.history.getActualFiredEventCount(a);if(e>=t.max)return c=!1,void n.addLog(!1,"random event have max value ".concat(t.max," but already fired ").concat(e," times"),3);n.addLog(!0,"random event have max value ".concat(t.max," and already fired ").concat(e," times"),3)}}))),{result:c,debugLogCollector:n,additionalData:{usedLimitationStrategyTags:s}}},t.prototype.verifyThreshold=function(t){var e=new o,a=0;if("number"!=typeof t||isNaN(t)||t%1!=0)try{a=this.sugarcubeFacade.runTeweeScript(t.toString())}catch(t){throw t.message="bad evaluation: "+t.message,t}else a=t;var r=Math.floor(100*Math.random());return r>a?(e.addLog(!1,"random value is greater than threshold (random=".concat(r," > threshold=").concat(a,")"),3),{result:!1,debugLogCollector:e}):(e.addLog(!0,"threshold passed (random="+r+" <= threshold="+a+")",3),{result:!0,debugLogCollector:e})},t}();var s;!function(t){t.Random="random",t.Sequential="sequential"}(s||(s={}));var c=__webpack_require__(766);const u=function(t,e){this.name=t,this.metadata=e},l=function(){function t(){this.items={}}return t.prototype.add=function(t){if(!(t instanceof u))throw new c.A("passage metadata should be instance of PassageMetadata");this.items[t.name]=t},t.prototype.has=function(t){if("string"!=typeof t)throw new c.A("name should be string");return void 0!==this.items[t]},t.prototype.get=function(t){if(!this.has(t))throw new c.A("PassageMetadata with name ".concat(t," doesn't exist"));return this.items[t]},t.prototype.find=function(t){return this.has(t)?this.items[t]:null},t}();var d=__webpack_require__(284);const g=function(){function t(){}return t.prototype.create=function(t){return new u(t.name,t)},t}(),h=function(){function t(t,e,a,r){void 0===e&&(e=/<<PassageMetadata>>(.*)<<\/PassageMetadata>>/gms),void 0===a&&(a="byTag"),void 0===r&&(r={filterTag:"passage_metadata"}),this.sugarcubeFacade=t,this.passageMetadataRegex=e,this.mode=a,this.modeParams=r}return t.prototype.init=function(){return this.passageMetadataCollection=this.createPassageMetadataCollection(),this.passageMetadataFactory=this.createPassageMetadataFactory(),this.passageMetadataCollector=new d.A(this.sugarcubeFacade,this.passageMetadataRegex,this.mode,this.modeParams),this},t.prototype.createPassageMetadataCollection=function(){return new l},t.prototype.createPassageMetadataFactory=function(){return new g},t.prototype.collect=function(){try{this.passageMetadataCollector.collect(this.passageMetadataCollection,this.passageMetadataFactory)}catch(t){throw t instanceof c.A&&(t.message+=" ("+Object.keys(t.scope).map((function(e){return"".concat(e,": ").concat(t.scope[e])})).join(", ")),t}},t}();var p,f=(p=function(t,e){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])},p(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function a(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}),y=function(t,e,a){if(a||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))};const v=function(t){function e(e){var a=t.call(this)||this;return a.tagsManager=e,a.tagIndex={},a.limitationStrategyTagIndex={},a.groupIndex={},a.validationGroup={},a}return f(e,t),e.prototype.add=function(e){var a=this;t.prototype.add.call(this,e),e.groups.all().forEach((function(t){if(void 0===a.validationGroup[t.name])a.validationGroup[t.name]={type:t.type.toString(),indexes:[t.sequentialIndex]};else{if(a.validationGroup[t.name].type!==t.type)throw new Error('Group type should be the same. Group name: "'.concat(t.name,'". Passage name: "').concat(e.name,'". Other passages: "').concat(a.groupIndex[t.name].join(", "),'"'));if(t.type===s.Sequential){if(a.validationGroup[t.name].indexes.includes(t.sequentialIndex))throw new Error("Random event with sequentialIndex ".concat(t.sequentialIndex," should be unique (name: ").concat(e.name,' ,group: "').concat(t.name,'")'));a.validationGroup[t.name].indexes.push(t.sequentialIndex)}}void 0===a.groupIndex[t.name]&&(a.groupIndex[t.name]=[]),a.groupIndex[t.name].push(e.name)})),y([],e.tags.stringTags,!0).forEach((function(t){void 0===a.tagIndex[t]&&(a.tagIndex[t]=[]),a.tagIndex[t].push(e.name)})),e.limitationStrategy.length>0&&e.limitationStrategy.isTaged&&e.limitationStrategy.all().forEach((function(t){a.tagsManager.prepareTags(t.tags).forEach((function(r){void 0===a.limitationStrategyTagIndex[r]&&(a.limitationStrategyTagIndex[r]={events:[],tagGroups:{}}),a.limitationStrategyTagIndex[r].events.push(e.name);var o=y([],a.tagsManager.prepareTags(t.tags),!0);t.isSeparate&&o.push(e.name),a.limitationStrategyTagIndex[r].tagGroups[a.tagsManager.convertTagsToStringKey(o)]=o}))}))},e.prototype.get=function(e){return t.prototype.get.call(this,e)},e.prototype.find=function(e){return t.prototype.find.call(this,e)},e.prototype.cleanUp=function(){this.validationGroup={}},e.prototype.enable=function(t){this.get(t).isEnabled=!0},e.prototype.disable=function(t){this.get(t).isEnabled=!1},e.prototype.getEventsNamesByTag=function(t){return void 0===this.tagIndex[t]?[]:this.tagIndex[t]},e.prototype.getEventsNamesByLimitationStrategyTag=function(t){return void 0===this.limitationStrategyTagIndex[t]?[]:this.limitationStrategyTagIndex[t].events},e.prototype.getTagGroupsByLimitationStrategyTag=function(t){return void 0===this.limitationStrategyTagIndex[t]?[]:Object.values(this.limitationStrategyTagIndex[t].tagGroups)},e.prototype.hasGroup=function(t){return void 0!==this.groupIndex[t]},e.prototype.getEventsNamesByGroup=function(t){var e;return null!==(e=this.groupIndex[t])&&void 0!==e?e:[]},e}(l),m=function(){function e(t,e,a,r,o){this.name=t,this.weight=e,this.type=a,this.sequentialIndex=r,this.sequentialCount=o}return e.createFromGroupPassageMetadata=function(a){var r,o;if("string"==typeof a)return new e(a.toLowerCase(),10,s.Random,null,null);if(t.isObject(a)){if(!t.isString(a.name))throw new Error('"definition.group.name" should be string');if(void 0!==a.weight&&!t.isInteger(a.weight))throw new Error('"definition.group.weight" should be integer');if(void 0!==a.type&&"random"!==a.type&&"sequential"!==a.type)throw new Error('"definition.group.type" should be "random" or "sequential"');if("sequential"===a.type){if(void 0===a.sequentialIndex)throw new Error('"definition.group.sequentialIndex" is requered when "definition.group.type" = "sequential"');if(!t.isInteger(a.sequentialIndex))throw new Error('"definition.group.sequentialIndex" should be integer');if(void 0!==a.sequentialCount&&!t.isInteger(a.sequentialCount))throw new Error('"definition.group.sequentialCount" should be integer')}return new e(a.name.toLowerCase(),null!==(r=a.weight)&&void 0!==r?r:10,"sequential"===a.type?s.Sequential:s.Random,"sequential"===a.type?a.sequentialIndex:null,"sequential"===a.type?null!==(o=a.sequentialCount)&&void 0!==o?o:1:null)}throw new Error('"definition.group" should be string, object')},e}(),b=function(){function t(t){var e=this;this.groups=t,this.nameIndex={},this.groups=t,this.groups.forEach((function(t,a){if(void 0!==e.nameIndex[t.name])throw new Error('"definition.group.name" should be unique in one RE');e.nameIndex[t.name]=a}))}return t.createFromGroupsPassageMetadata=function(e){return void 0===e?new t([]):(Array.isArray(e)||(e=[e]),new t(e.map((function(t){return m.createFromGroupPassageMetadata(t)}))))},Object.defineProperty(t.prototype,"length",{get:function(){return this.groups.length},enumerable:!1,configurable:!0}),t.prototype.all=function(){return this.groups},t.prototype.getByName=function(t){return void 0===this.nameIndex[t]?null:this.groups[this.nameIndex[t]]},t}();var w=function(){var t=function(e,a){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])},t(e,a)};return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function r(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}}();const _=function(t){function e(e,a,r,o,i,n,s,c,u){var l=t.call(this,e,a)||this;return l.isEnabled=r,l.groups=o,l.filter=i,l.type=n,l.threshold=s,l.tags=c,l.limitationStrategy=u,l}return w(e,t),e}(u),L=function(){function t(e){var a=this;this.isHaveTweeScriptTags=!1,this.tags=[],this.stringTags=[],e.forEach((function(e){t.isHaveTweeScript(e)?(a.tags.push({isHaveTweeScript:!0,tag:e}),a.isHaveTweeScriptTags=!0):(e=e.toLowerCase().trim().replace(" ","__"),a.tags.push({isHaveTweeScript:!1,tag:e}),a.stringTags.push(e))})),this.stringTags.sort(),this.isHaveTweeScriptTags||(this.tags=null)}return t.isHaveTweeScript=function(t){return!/^\w+[\w_\- ]+$/.test(t)},t.createFromTagsDefinition=function(e){if(void 0===e)return new t([]);if(!Array.isArray(e))throw new Error('"definition.tags" should be array');return new t(e.map((function(t){if("string"!=typeof t)throw new Error('"definition.tags[...]" should be string');return t})))},Object.defineProperty(t.prototype,"length",{get:function(){return this.isHaveTweeScriptTags?this.tags.length:this.stringTags.length},enumerable:!1,configurable:!0}),t}();var E=function(){var t=function(e,a){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])},t(e,a)};return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function r(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}}();const C=function(t){function e(e){var a=t.call(this)||this;return a.limitationStrategyFactory=e,a}return E(e,t),e.prototype.create=function(t){if("string"!=typeof t.name)throw new Error('"PassageMetadata.name" should be string');if(void 0===t.isEnabled)t.isEnabled=!0;else if("boolean"!=typeof t.isEnabled)throw new Error('"definition.isEnabled" should be boolean (name: '.concat(t.name,")"));try{t.groups=b.createFromGroupsPassageMetadata(t.groups)}catch(e){throw e.message="".concat(e.message," (name: ").concat(t.name,")"),e}if(void 0===t.filter)t.filter=null;else if(null!==t.filter&&"string"!=typeof t.filter)throw new Error('"definition.filter" should be string or null (name: '.concat(t.name,")"));if(void 0===t.type)t.type="embedded";else if("embedded"!==t.type&&"goto"!==t.type)throw new Error('"definition.type" should be "embedded" or "goto" (name: '.concat(t.name,")"));if(void 0===t.threshold)t.threshold=100;else if("number"==typeof t.threshold){if(t.threshold<0)throw new Error('"definition.threshold" should be >= than 0 (name: '.concat(t.name,")"));if(t.threshold>100)throw new Error('"definition.threshold" should be <= than 100 (name: '.concat(t.name,")"))}try{t.tags=L.createFromTagsDefinition(t.tags)}catch(e){throw e.message="".concat(e.message," (name: ").concat(t.name,")"),e}try{t.limitationStrategy=this.limitationStrategyFactory.createLimitationStrategyListFromPassageMetadata(t.limitationStrategy)}catch(e){throw e.message="".concat(e.message," (name: ").concat(t.name,")"),e}return new _(t.name,t,t.isEnabled,t.groups,t.filter,t.type,t.threshold,t.tags,t.limitationStrategy)},e}(g);var S=function(){var t=function(e,a){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])},t(e,a)};return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function r(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}}();const T=function(t){function e(e,a,r,o,i,n){void 0===o&&(o=/<<PassageMetadata>>(.*)<<\/PassageMetadata>>/gms),void 0===i&&(i="byTag"),void 0===n&&(n={filterTag:"passage_metadata"});var s=t.call(this,r,o,i,n)||this;return s.tagsManager=e,s.limitationStrategyFactory=a,s}return S(e,t),e.prototype.createPassageMetadataCollection=function(){return new v(this.tagsManager)},e.prototype.createPassageMetadataFactory=function(){return new C(this.limitationStrategyFactory)},e.prototype.collect=function(){t.prototype.collect.call(this),this.passageMetadataCollection.cleanUp()},e}(h),M=function(){function t(){}return t.prototype.getAllPassages=function(){return Story.lookup()},t.prototype.runTeweeScript=function(t){return Scripting.evalJavaScript(Scripting.parse(t))},t.prototype.hasPassage=function(t){return Story.has(t)},t.prototype.saveVariable=function(t,e){State.variables[t]=e},t}();const F=function(){function t(t){this.sugarcubeFacade=t}return t.isTagHaveTweeScript=function(t){return!/^\w+[\w_\- ]+$/.test(t)},t.prototype.prepareTags=function(e){var a=this;return e instanceof L?e.isHaveTweeScriptTags?e.tags.map((function(t){if(!t.isHaveTweeScript)return t.tag;try{return a.sugarcubeFacade.runTeweeScript(t.tag).toLowerCase().trim().replace(" ","__")}catch(e){throw new Error("Invalid random event scripted tag: "+t.tag)}})).sort():function(t,e,a){if(a||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}([],e.stringTags,!0).sort():e.map((function(e){if(!t.isTagHaveTweeScript(e))return e;try{return a.sugarcubeFacade.runTeweeScript(e).toLowerCase().trim().replace(" ","__")}catch(t){throw new Error("Invalid random event scripted tag: "+e)}})).sort()},t.prototype.convertTagsToStringKey=function(t){return this.prepareTags(t).join("_")},t}(),x=function(t,e,a){if(this.max=t,this.isSeparate=e,this.tags=a,a.isHaveTweeScriptTags)throw new Error('"definition.limitationStrategy[...].tags" should be string')},P=function(){function t(t){var e=this;this.limitationStrategies=t,this.isTaged=!1,this.limitationStrategies.forEach((function(t){!e.isTaged&&t.tags.length>0&&(e.isTaged=!0)}))}return Object.defineProperty(t.prototype,"length",{get:function(){return this.limitationStrategies.length},enumerable:!1,configurable:!0}),t.prototype.all=function(){return this.limitationStrategies},t}(),O=function(){function e(t){this.tagsManager=t}return e.prototype.createLimitationStrategyListFromPassageMetadata=function(e){var a=this;if(void 0===e)return new P([]);if(!t.isArray(e))throw new Error('"passageMetadata.limitationStrategy" should be array');var r=new P(e.map((function(t){return a.createLimitationStrategyFromPassageMetadata(t)}))),o={};return r.all().forEach((function(t){var e=a.tagsManager.convertTagsToStringKey(t.tags);if(void 0!==o[e])throw new Error('"passageMetadata.limitationStrategy" should containg uniq tag sets (tags: "'.concat(t.tags.tags.map((function(t){return t.tag})).join('", "'),'")'));o[e]=!0})),r},e.prototype.createLimitationStrategyFromPassageMetadata=function(e){var a;if(!t.isInteger(e.max))throw new Error('"passageMetadata.limitationStrategy[...].max" should be integer');if(e.max<0)throw new Error('"passageMetadata.limitationStrategy[...].max" should equal or greater than 0');if(void 0!==e.isSeparate&&!t.isBoolean(e.isSeparate))throw new Error('"passageMetadata.limitationStrategy[...].isSeparate" should be boolean');return new x(e.max,null!==(a=e.isSeparate)&&void 0!==a&&a,L.createFromTagsDefinition(e.tags))},e}();var k=function(){return k=Object.assign||function(t){for(var e,a=1,r=arguments.length;a<r;a++)for(var o in e=arguments[a])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},k.apply(this,arguments)},I=function(t,e,a){if(a||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))};const A=function(){function i(t,i,s,c){void 0===t&&(t=/<<PassageMetadata>>(.*)<<\/PassageMetadata>>/gms),void 0===i&&(i="byTag"),void 0===s&&(s={filterTag:"passage_metadata"}),void 0===c&&(c=0);var u=this;this.passageMetadataModeParams=s,this.acquireLock=function(){return u.lock.acquire()},this.releaseLock=function(){return u.lock.release()},this.forceAcquireLock=function(){return u.lock.forceAcquire()},this.forceReleaseLock=function(){return u.lock.forceRelease()},this.loadState=function(t){return u.stateLoader.loadState(t)},this.setStateAsLoaded=function(){return u.stateLoader.forceSetIsLoadedFlag(!0)},this.resetStateLoadedFlag=function(){return u.stateLoader.resetIsLoadedFlag()},this.has=function(t){return u.passageMetadataCollection.has(t)},this.find=function(t){return u.passageMetadataCollection.find(t)},this.sugarcubeFacade=new M,this.tagsManager=new F(this.sugarcubeFacade),this.limitationStrategyFactory=new O(this.tagsManager),this.passageMetadataApp=new T(this.tagsManager,this.limitationStrategyFactory,this.sugarcubeFacade,t,i,s),this.passageMetadataApp.init(),this.passageMetadataCollection=this.passageMetadataApp.passageMetadataCollection,this.history=new e(this.sugarcubeFacade),this.stateLoader=new r(this.passageMetadataApp.passageMetadataCollection,this.history),this.lock=new a,this.debugLogCollector=new o(c),this.constraintsVerificator=new n(this.sugarcubeFacade,this.tagsManager,this.history)}return i.prototype.init=function(){this.passageMetadataApp.collect()},Object.defineProperty(i.prototype,"isLocked",{get:function(){return this.lock.isLocked},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isForceLocked",{get:function(){return this.lock.isForce},enumerable:!1,configurable:!0}),i.prototype.enable=function(t){if(!this.passageMetadataCollection.has(t)){if(!this.sugarcubeFacade.hasPassage(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.passageMetadataModeParams.filterTag,'"'))}this.passageMetadataCollection.enable(t),this.history.enable(t)},i.prototype.disable=function(t){if(!this.passageMetadataCollection.has(t)){if(!this.sugarcubeFacade.hasPassage(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.passageMetadataModeParams.filterTag,'"'))}this.passageMetadataCollection.disable(t),this.history.disable(t)},i.prototype.enableByTag=function(t){var e=this;t=t.toLowerCase(),this.passageMetadataCollection.getEventsNamesByTag(t).forEach((function(t){e.passageMetadataCollection.enable(t),e.history.enable(t,!1)})),this.history.store()},i.prototype.disableByTag=function(t){var e=this;t=t.toLowerCase(),this.passageMetadataCollection.getEventsNamesByTag(t).forEach((function(t){e.passageMetadataCollection.disable(t),e.history.disable(t,!1)})),this.history.store()},i.prototype.resetFiredCounterByRandomEvent=function(t){if(!this.passageMetadataCollection.has(t)){if(!this.sugarcubeFacade.hasPassage(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.passageMetadataModeParams.filterTag,'"'))}this.history.resetRandomEventFiredCounter(t)},i.prototype.resetFiredCounterByTag=function(t){var e=this;t=t.toLowerCase(),this.history.resetTagFiredCounter(t,!1),this.passageMetadataCollection.getEventsNamesByTag(t).forEach((function(t){e.history.resetRandomEventFiredCounter(t,!1)})),this.passageMetadataCollection.getEventsNamesByLimitationStrategyTag(t).forEach((function(t){e.history.resetRandomEventFiredCounter(t,!1)})),this.passageMetadataCollection.getTagGroupsByLimitationStrategyTag(t).forEach((function(t){var a=e.tagsManager.convertTagsToStringKey(t);e.history.resetTagFiredCounter(a,!1)})),this.history.store()},i.prototype.runRandomEvent=function(t,e){if(this.debugLogCollector.clear(),e=k({isValidateIsEnable:!0,isEnable:null,isValidateFilter:!0,filter:null,isValidateLimitationStrategy:!0,limitationStrategy:null,isValidateThreshold:!0,threshold:null},null!=e?e:{}),!this.passageMetadataCollection.has(t)){if(!this.sugarcubeFacade.hasPassage(t))throw new Error('passage "'.concat(t,'" does not exist'));throw new Error('passage "'.concat(t,'" exist but without tag "').concat(this.passageMetadataModeParams.filterTag,'"'))}var a=this.passageMetadataCollection.get(t);this.debugLogCollector.addLog(null,"Start random event ".concat(a.name),1),this.debugLogCollector.increaseLevel();var r=!0;if(this.lock.isLocked)return r=!1,this.debugLogCollector.addLog(null,"Skip because lock already acquired",1),{isSuccess:r,debugLogCollector:this.debugLogCollector,passageMetadata:a,usedTags:[]};try{var o=this.tagsManager.prepareTags(a.tags),i=this.constraintsVerificator.verify(a,e);return r=i.result,this.debugLogCollector.addLog(null,"Verify:",2).increaseLevel().merge(i.debugLogCollector).decreaseLevel(),{isSuccess:r,debugLogCollector:this.debugLogCollector,passageMetadata:a,usedTags:a.limitationStrategy.isTaged?i.additionalData.usedLimitationStrategyTags:[o]}}catch(t){throw t}},i.prototype.runGroup=function(e,a,r){var o=this;if(e=e.toLowerCase(),this.debugLogCollector.clear(),r=k({isValidateIsEnable:!0,isEnable:null,isValidateFilter:!0,filter:null,isValidateLimitationStrategy:!0,limitationStrategy:null,isValidateThreshold:!0,threshold:null},null!=r?r:{}),!this.passageMetadataCollection.hasGroup(e))throw new Error('group "'.concat(e,'" does not exist'));this.debugLogCollector.addLog(null,"Start group ".concat(e),1),this.debugLogCollector.increaseLevel();var i=!0;if(this.lock.isLocked)return i=!1,this.debugLogCollector.addLog(null,"Skip because lock already acquired",1),{isSuccess:i,debugLogCollector:this.debugLogCollector};if(t.isNumber(a)||t.isString(a)){try{i=(p=this.constraintsVerificator.verifyThreshold(a)).result,this.debugLogCollector.addLog(null,"Verify group threshold",2).increaseLevel().merge(p.debugLogCollector).decreaseLevel()}catch(t){throw t}if(!1===i)return{isSuccess:i,debugLogCollector:this.debugLogCollector};r.isValidateThreshold=!1}this.debugLogCollector.increaseLevel().addLog(null,"Verify random events in group",1).increaseLevel();for(var n=0,c=[],u=this.passageMetadataCollection.getEventsNamesByGroup(e),l=0;l<u.length;l++){var d=u[l];if(!this.passageMetadataCollection.has(d)){if(!this.sugarcubeFacade.hasPassage(d))throw new Error('passage "'.concat(d,'" does not exist'));throw new Error('passage "'.concat(d,'" exist but without tag "').concat(this.passageMetadataModeParams.filterTag,'"'))}var g=this.passageMetadataCollection.get(d),h=g.groups.getByName(e);if(null===h)throw new Error("Can't find group \"".concat(e,'" in random event ').concat(g.name));this.debugLogCollector.addLog(null,"Random event ".concat(g.name," with weight ").concat(h.weight),1).increaseLevel();try{var p,f=this.tagsManager.prepareTags(g.tags),y=(p=this.constraintsVerificator.verify(g,r)).result;this.debugLogCollector.addLog(null,"Verify",2).increaseLevel().merge(p.debugLogCollector).decreaseLevel(),y&&(n+=h.weight,c.push({isSuccess:y,passageMetadata:g,usedTags:g.limitationStrategy.isTaged?p.additionalData.usedLimitationStrategyTags:[f],group:h}))}catch(t){throw t}this.debugLogCollector.decreaseLevel()}if(c.length<=0)return i=!1,this.debugLogCollector.addLog(!1,"not found any suitable random events in group",2),{isSuccess:i,debugLogCollector:this.debugLogCollector};var v=null;if(c[0].group.type===s.Sequential){this.debugLogCollector.addLog(!0,"Find winner event",2).increaseLevel();var m=c.filter((function(t){return o.history.getHistoryFiredEventCount(t.passageMetadata.name)<t.group.sequentialCount}));if(this.debugLogCollector.addLog(!0,"sequential search found ".concat(m.length," siutable events"),3),m.length>0)return v=m.sort((function(t,e){return t.group.sequentialIndex-e.group.sequentialIndex}))[0],this.debugLogCollector.addLog(!0,"winner random event: ".concat(v.passageMetadata.name),3),{isSuccess:i,debugLogCollector:this.debugLogCollector,passageMetadata:v.passageMetadata,usedTags:v.usedTags,group:v.group}}var b=Math.floor(Math.random()*n);this.debugLogCollector.addLog(!0,"total weight: ".concat(n," | wittner weight: ").concat(b),3);for(var w=0;w<c.length;w++)if((b-=c[w].group.weight)<=0){v=c[w];break}return this.debugLogCollector.addLog(!0,"winner random event: ".concat(v.passageMetadata.name),3),{isSuccess:i,debugLogCollector:this.debugLogCollector,passageMetadata:v.passageMetadata,usedTags:v.usedTags,group:v.group}},i.prototype.incrementCounters=function(t,e){var a=this;this.history.incrementRandomEventFiredCounter(t.name,!1),e.forEach((function(t){a.history.incrementTagsFiredCounter(I(I([],t,!0),[a.tagsManager.convertTagsToStringKey(t)],!1),!1)})),this.history.store(),this.stateLoader.forceSetIsLoadedFlag(!0)},i}()})(),RandomEventAppExport=__webpack_exports__})();

    var RandomEventApp = RandomEventAppExport.default;

    ////////////////////////////////
    // Initialize random event block
    ////////////////////////////////

    var re = new RandomEventApp(
        /<<PassageMetadata>>(.*)<<\/PassageMetadata>>/gms,
        'byTag',
        { filterTag: 'passage_metadata' },
        3, // max debug level
    );
    re.init();

    // TODO start: If somebody knows how to rewrite these more beautifully/correctly, please let me know :)
    $(document).on(':passageend', function() {
        re.releaseLock();
    });

    Engine = new Proxy(Engine, {
        get: function(target, prop) {
            if (prop === 'backward' || prop === 'forward') {
                jQuery.event.trigger({
                    type: ':called_' + prop,
                });
            }

            return target[prop];
        }
    });

    $(document).on(':called_backward', function() {
        re.resetStateLoadedFlag();
    });
    $(document).on(':called_forward', function() {
        re.resetStateLoadedFlag();
    });

    Config.navigation.override = (destinationPassage) => {
        if (re.isLocked && !re.has(destinationPassage)) {
            // if random event fired in <<button>> or <<link>>, return previous passage to normal history forward work
            return passage();
        }

        return destinationPassage;
    };

    Save.onLoad.add((save) => {
        if (save.state.history.length > 0) {
            var historyVariables = save.state.history[save.state.history.length-1].variables;

            re.loadState(historyVariables);
        }
        re.setStateAsLoaded();
    });
    // TODO end

    ///////////////////////////
    // Macros declaration block
    ///////////////////////////

    Macro.add('REEnable', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                re.loadState(State.variables);
                re.enable(randomEventPassageName);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later
    Macro.add('REEnableByTag', {
        handler: function() {
            if (this.args.length !== 1) {
				return this.error('Need to pass just 1 tag');
			}

            if (typeof this.args[0] !== 'string') {
                return this.error('Random event tag should be a string value');
            }

            try {
                re.loadState(State.variables);
                re.enableByTag(this.args[0]);
            } catch(err) {
                this.error(err.message);
            }
        },
    });

    Macro.add('REDisable', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                re.loadState(State.variables);
                re.disable(randomEventPassageName);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later
    Macro.add('REDisableByTag', {
        handler: function() {
            if (this.args.length !== 1) {
				return this.error('Need to pass just 1 tag');
			}

            if (typeof this.args[0] !== 'string') {
                return this.error('Random event tag should be a string value');
            }

            try {
                re.loadState(State.variables);
                re.disableByTag(this.args[0]);
            } catch(err) {
                this.error(err.message);
            }
        },
    });

    Macro.add('REReset', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                re.loadState(State.variables);
                re.resetFiredCounterByRandomEvent(randomEventPassageName);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    // TODO: Currently work only with 1 tag, will add possibility to pass multiply tags later
    Macro.add('REResetByTag', {
        handler: function() {
            if (this.args.length !== 1) {
				return this.error('Need to pass just 1 tag');
			}

            if (typeof this.args[0] !== 'string') {
                return this.error('Random event tag should be a string value');
            }

            try {
                re.loadState(State.variables);
                re.resetFiredCounterByTag(this.args[0]);
            } catch (err) {
                this.error(err.message);
            }
        },
    });

    Macro.add('RE', {
        handler: function() {
            if (this.args.length === 0) {
				return this.error('No random event passage name specified');
			}

            var randomEventPassageName;
			if (typeof this.args[0] === 'object') {
				randomEventPassageName = this.args[0].link;
			} else {
				randomEventPassageName = this.args[0];
			}

            try {
                // TODO: maybe need to add more rewrite widget arguments
                var result = re.runRandomEvent(randomEventPassageName, {
                    threshold: this.args[1]
                });
            } catch (err) {
                this.error(err.message);
            }

            if (Config.debug) {
                var debugLog = 'RE "' + result.passageMetadata.name + '"';
                if (result.debugLogCollector.debugLevel > 0) {
                    debugLog = result.debugLogCollector.toString();
                }
                this.debugView.name = 'RE "' + result.passageMetadata.name + '"';
                this.debugView.title = debugLog;
                this.debugView.modes({
                    nonvoid: true,
                    hidden: false,
                    invalid: !result.isSuccess
                });

                if (result.debugLogCollector.debugLevel > 0) {
                    console.log(debugLog);
                }
            }

            if (result.isSuccess) {
                re.incrementCounters(result.passageMetadata, result.usedTags);

                if (result.passageMetadata.type === 'embedded') {
                    var $el = jQuery(this.output);
                    $el.wiki(Story.get(result.passageMetadata.name).processText());
                } else {
                    re.acquireLock();
                    setTimeout(function() { Engine.play(result.passageMetadata.name, true), Engine.minDomActionDelay });
                }
            }
        },
    });

    Macro.add('REGroup', {
        handler: function() {
            if (typeof this.args[0] !== 'string') {
                return this.error('Random event group name should be a string value');
            }
            var groupName = this.args[0].toLowerCase();

            try {
                // TODO: maybe need to add more rewrite widget arguments
                var result = re.runGroup(groupName, this.args[1]);
            } catch (err) {
                this.error(err.message);
            }

            if (Config.debug) {
                var debugLog = 'REGroup "' + groupName + '"';
                if (result.debugLogCollector.debugLevel > 0) {
                    debugLog = result.debugLogCollector.toString();
                }
                this.debugView.name = 'REGroup "' + groupName + '"';
                this.debugView.title = debugLog;
                this.debugView.modes({
                    nonvoid: true,
                    hidden: false,
                    invalid: !result.isSuccess
                });

                if (result.debugLogCollector.debugLevel > 0) {
                    console.log(debugLog);
                }
            }

            if (result.isSuccess) {
                re.incrementCounters(result.passageMetadata, result.usedTags);

                if (result.passageMetadata.type === 'embedded') {
                    var $el = jQuery(this.output);
                    $el.wiki(Story.get(result.passageMetadata.name).processText());
                } else {
                    re.acquireLock();
                    setTimeout(function() { Engine.play(result.passageMetadata.name, true), Engine.minDomActionDelay });
                }
            }
        },
    });

    ///////////////////////
    // Public methods block
    ///////////////////////

    window.isHasRE = (passageName = '') => {
        return re.has(passageName);
    }

    window.isPassageRE = function() {
        return re.has(passage());
    }

    window.isPreviousRE = function() {
        return randomEventCollection.has(previous());
    }

    window.isREFired = (passageName = '', isUseHistory = true) => {
        if (isUseHistory) {
            return re.history.getHistoryFiredEventCount(passageName) > 0;
        }

        return re.history.getActualFiredEventCount(passageName) > 0;
    }

    window.isRETagFired = (tag = '', isUseHistory = true) => {
        if (isUseHistory) {
            return re.history.getHistoryFiredTagCount(tag) > 0;
        }

        return re.history.getActualFiredTagCount(tag) > 0;
    }
}());
